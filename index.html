<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§é€š</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: "Microsoft YaHei", sans-serif; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #404040 100%); }
        
        .login-container { width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: rgba(255,255,255,0.95); border-radius: 28px; padding: 50px; width: 100%; max-width: 450px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-icon { text-align: center; font-size: 70px; margin-bottom: 25px; }
        .login-title { text-align: center; margin-bottom: 35px; }
        .login-title h1 { font-size: 32px; color: #1E293B; margin-bottom: 10px; }
        .login-title p { color: #64748b; font-size: 16px; }
        .login-input { margin-bottom: 22px; }
        .login-input input { width: 100%; padding: 18px; border: 2px solid #E2E8F0; border-radius: 14px; font-size: 17px; outline: none; }
        .login-input input:focus { border-color: #888888; }
        .login-btn { width: 100%; padding: 18px; font-size: 18px; border: none; border-radius: 14px; background: linear-gradient(135deg, #666666 0%, #444444 100%); color: white; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 102, 102, 0.4); }
        .login-error { text-align: center; color: #EF4444; font-size: 15px; margin-top: 18px; display: none; }
        .role-select { display: flex; gap: 20px; margin-bottom: 30px; }
        .role-btn { flex: 1; padding: 25px; border: 3px solid #E2E8F0; border-radius: 16px; background: white; cursor: pointer; transition: all 0.3s; text-align: center; }
        .role-btn:hover { border-color: #888888; transform: translateY(-3px); }
        .role-btn.active { border-color: #888888; background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); }
        .role-btn-icon { font-size: 50px; margin-bottom: 10px; }
        .role-btn-text { font-size: 18px; font-weight: bold; color: #1E293B; }
        .role-btn-desc { font-size: 13px; color: #64748b; margin-top: 5px; }
        .back-btn { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px solid #e2e8f0; color: #64748b; font-size: 14px; cursor: pointer; padding: 12px 20px; border-radius: 12px; display: flex; align-items: center; gap: 8px; transition: all 0.3s; font-weight: 500; margin-bottom: 20px; }
        .back-btn:hover { background: linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%); border-color: #888888; color: #666666; transform: translateX(-3px); box-shadow: 0 4px 15px rgba(102, 102, 102, 0.2); }
        
        .main-container { width: 100%; height: 100vh; display: none; flex-direction: column; }
        .main-container.active { display: flex; }
        .top-bar { background: rgba(0,0,0,0.3); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(10px); }
        .top-bar h1 { color: white; font-size: 22px; }
        .top-bar-right { display: flex; align-items: center; gap: 20px; position: relative; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #888888 0%, #666666 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; border: 2px solid rgba(255,255,255,0.3); }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .user-dropdown { position: absolute; top: 100%; right: 0; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); min-width: 180px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s; z-index: 100; overflow: hidden; }
        .top-bar-right:hover .user-dropdown { opacity: 1; visibility: visible; transform: translateY(10px); }
        .dropdown-header { padding: 15px; background: linear-gradient(135deg, #888888 0%, #666666 100%); color: white; text-align: center; }
        .dropdown-header-name { font-weight: bold; font-size: 15px; }
        .dropdown-header-role { font-size: 12px; opacity: 0.8; margin-top: 4px; }
        .dropdown-item { display: flex; align-items: center; gap: 10px; padding: 12px 15px; color: #475569; cursor: pointer; transition: all 0.2s; border: none; background: none; width: 100%; text-align: left; font-size: 14px; }
        .dropdown-item:hover { background: #f1f5f9; color: #888888; }
        .dropdown-item.danger { color: #EF4444; }
        .dropdown-item.danger:hover { background: #FEE2E2; }
        .dropdown-divider { height: 1px; background: #E2E8F0; margin: 5px 0; }
        .user-info { color: white; font-size: 15px; }
        .logout-btn { padding: 10px 24px; font-size: 14px; background: rgba(255,255,255,0.2); border: none; border-radius: 20px; color: white; cursor: pointer; transition: all 0.3s; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        
        .content-area { flex: 1; display: flex; overflow: hidden; }
        .sidebar { width: 200px; background: rgba(0,0,0,0.2); padding: 20px 15px; display: flex; flex-direction: column; gap: 8px; backdrop-filter: blur(10px); }
        .sidebar-btn { padding: 14px 18px; border: none; border-radius: 12px; background: transparent; color: rgba(255,255,255,0.7); font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 10px; }
        .sidebar-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .sidebar-btn.active { background: rgba(255,255,255,0.25); color: white; }
        .sidebar.student-sidebar { background: rgba(100,100,100,0.3); }
        
        .main-content { flex: 1; padding: 25px; overflow-y: auto; background: rgba(255,255,255,0.1); }
        .screen { display: none; }
        .screen.active { display: block; }
        
        .card { background: rgba(255,255,255,0.95); border-radius: 20px; padding: 28px; margin-bottom: 22px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
        .card-title { font-size: 20px; font-weight: bold; color: #1E293B; margin-bottom: 22px; display: flex; align-items: center; gap: 10px; }
        .form-row { display: flex; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; }
        input, textarea, select { padding: 14px 18px; border: 2px solid #E2E8F0; border-radius: 12px; font-size: 15px; outline: none; transition: all 0.3s; background: #f8fafc; }
        input:focus, textarea:focus, select:focus { border-color: #888888; background: white; }
        .btn { padding: 14px 26px; border: none; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #888888 0%, #666666 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #666666 0%, #555555 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #666666 0%, #555555 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #777777 0%, #666666 100%); color: white; }
        .btn-purple { background: linear-gradient(135deg, #777777 0%, #666666 100%); color: white; }
        .btn-small { padding: 10px 16px; font-size: 13px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 18px; margin-bottom: 22px; }
        .stat-card { background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); border-radius: 16px; padding: 22px; text-align: center; }
        .stat-num { font-size: 32px; font-weight: bold; color: #666666; }
        .stat-label { font-size: 13px; color: #64748b; margin-top: 6px; }
        
        .table-container { max-height: 350px; overflow-y: auto; border: 2px solid #E2E8F0; border-radius: 12px; }
        .student-table { width: 100%; border-collapse: collapse; }
        .student-table th, .student-table td { padding: 12px 14px; text-align: left; border-bottom: 1px solid #E2E8F0; }
        .student-table th { background: #f8fafc; font-weight: bold; color: #475569; }
        .student-table tr:hover { background: #f8fafc; }
        .student-table input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        
        .homework-item { background: #f0f0f0; border-radius: 14px; padding: 20px; margin-bottom: 15px; border-left: 4px solid #888888; }
        .homework-title { font-size: 17px; font-weight: bold; color: #1E293B; margin-bottom: 8px; }
        .homework-info { font-size: 13px; color: #64748b; margin-bottom: 10px; }
        .homework-content { color: #475569; line-height: 1.6; }
        
        .message-item { background: #f0f0f0; border-radius: 14px; padding: 18px; margin-bottom: 14px; border-left: 4px solid #888888; }
        .message-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .message-from { font-weight: bold; color: #1E293B; }
        .message-time { font-size: 13px; color: #94A3B8; }
        .message-content { color: #475569; line-height: 1.6; }
        
        /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
        .chat-container { background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 15px; height: calc(100% - 120px); overflow-y: auto; }
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        .chat-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .message-bubble { max-width: 70%; padding: 12px 16px; border-radius: 16px; margin-bottom: 12px; position: relative; }
        .message-bubble.me { background: linear-gradient(135deg, #888888 0%, #666666 100%); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .message-bubble.other { background: #f1f5f9; color: #1E293B; align-self: flex-start; border-bottom-left-radius: 4px; }
        .message-content { line-height: 1.4; margin-bottom: 4px; word-wrap: break-word; }
        .message-info { font-size: 11px; color: #94A3B8; display: flex; justify-content: flex-end; align-items: center; gap: 5px; }
        .message-info.me { color: rgba(255,255,255,0.7); }
        .message-status { opacity: 0.7; font-size: 10px; }
        
        /* èŠå¤©è¾“å…¥åŒºåŸŸ */
        .chat-input-area { display: flex; gap: 10px; margin-top: 15px; }
        .chat-input { flex: 1; padding: 14px 18px; border: 2px solid #E2E8F0; border-radius: 25px; font-size: 15px; outline: none; resize: none; }
        .chat-input:focus { border-color: #888888; background: white; }
        .chat-send-btn { padding: 14px 24px; border: none; border-radius: 25px; background: linear-gradient(135deg, #888888 0%, #666666 100%); color: white; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .chat-send-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 102, 102, 0.4); }
        .chat-send-btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .score-item { background: #f0f0f0; border-radius: 14px; padding: 18px; margin-bottom: 14px; display: flex; justify-content: space-between; align-items: center; }
        .score-info { display: flex; flex-direction: column; gap: 4px; }
        .score-type { font-weight: bold; color: #1E293B; }
        .score-time { font-size: 12px; color: #94A3B8; }
        .score-value { font-size: 28px; font-weight: bold; }
        .score-high { color: #666666; }
        .score-mid { color: #888888; }
        .score-low { color: #999999; }
        
        .roll-display { background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); border-radius: 20px; padding: 60px; text-align: center; margin-bottom: 25px; }
        .roll-result { font-size: 48px; font-weight: bold; color: #666666; min-height: 80px; }
        .roll-info { font-size: 16px; color: #64748b; margin-top: 15px; }
        
        .call-alert { background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); border-radius: 14px; padding: 22px; margin-bottom: 15px; border-left: 4px solid #888888; display: none; }
        .call-alert-title { font-size: 18px; font-weight: bold; color: #666666; margin-bottom: 10px; }
        .call-alert-content { color: #888888; font-size: 15px; }
        
        .friend-item { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; border-radius: 12px; padding: 14px 18px; margin-bottom: 12px; }
        .friend-info { display: flex; align-items: center; gap: 12px; }
        .friend-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold; }
        .friend-name { font-weight: bold; color: #1E293B; }
        .friend-status { font-size: 13px; color: #64748b; }
        
        .tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .tag-success { background: #D1FAE5; color: #059669; }
        .tag-warning { background: #FEF3C7; color: #D97706; }
        .tag-danger { background: #FEE2E2; color: #DC2626; }
        
        .empty-state { text-align: center; padding: 50px 20px; color: #94A3B8; }
        .empty-state-icon { font-size: 50px; margin-bottom: 15px; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal-card { background: white; border-radius: 20px; padding: 35px; width: 90%; max-width: 550px; max-height: 85vh; overflow-y: auto; }
        .modal-title { font-size: 22px; font-weight: bold; color: #1E293B; margin-bottom: 25px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: bold; color: #475569; margin-bottom: 8px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; }
        .btn-group { display: flex; gap: 15px; margin-top: 25px; }
        .btn-group .btn { flex: 1; }
        
        .notification-badge { position: absolute; top: -5px; right: -5px; background: #EF4444; color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; display: none; }
        .notification-badge.active { display: block; }
        .hidden { display: none !important; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .tip-text { font-size: 13px; color: #94A3B8; text-align: center; margin-bottom: 18px; }
    </style>
</head>
<body>
    <div id="role-select-screen" class="login-container">
        <div class="login-card">
            <div class="login-title">
                <h1>ğŸ“‹ ç­çº§é€š</h1>
                <p>è¯·é€‰æ‹©æ‚¨çš„èº«ä»½</p>
            </div>
            <div class="role-select">
                <div class="role-btn active" onclick="selectRole('teacher')">
                    <div class="role-btn-icon">ğŸ‘©â€ğŸ«</div>
                    <div class="role-btn-text">æ•™å¸ˆç«¯</div>
                    <div class="role-btn-desc">ç®¡ç†å­¦ç”Ÿã€ç‚¹åã€æ‰“åˆ†</div>
                </div>
                <div class="role-btn" onclick="selectRole('student')">
                    <div class="role-btn-icon">ğŸ‘¨â€ğŸ“</div>
                    <div class="role-btn-text">å­¦ç”Ÿç«¯</div>
                    <div class="role-btn-desc">ç­¾åˆ°ã€æŸ¥çœ‹æˆç»©ã€ä½œä¸š</div>
                </div>
            </div>
            <button class="login-btn" onclick="goToLogin()">è¿› å…¥ ç³» ç»Ÿ</button>
        </div>
    </div>
    
    <div id="teacher-login-screen" class="login-container hidden">
        <div class="login-card">
            <button class="back-btn" onclick="backToRoleSelect()">â† è¿”å›é€‰æ‹©èº«ä»½</button>
            <div class="login-icon">ğŸ‘©â€ğŸ«</div>
            <div class="login-title">
                <h1>æ•™å¸ˆç™»å½•</h1>
                <p>è¯·è¾“å…¥è´¦å·å¯†ç </p>
            </div>
            <div class="login-input">
                <input type="text" id="teacher-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="off">
            </div>
            <div class="login-input">
                <input type="password" id="teacher-password" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="off">
            </div>
            <button class="login-btn" onclick="doTeacherLogin()">ç™» å½•</button>
            <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="showTeacherRegister()" style="color: #667eea; font-size: 14px; text-decoration: none;">æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ</a>
            </div>
            <div id="teacher-login-error" class="login-error">ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼</div>
        </div>
    </div>
    
    <div id="teacher-register-screen" class="login-container hidden">
        <div class="login-card">
            <button class="back-btn" onclick="backToTeacherLogin()">â† è¿”å›ç™»å½•</button>
            <div class="login-icon">ğŸ“</div>
            <div class="login-title">
                <h1>æ•™å¸ˆæ³¨å†Œ</h1>
                <p>é€šè¿‡é‚®ç®±éªŒè¯æ³¨å†Œ</p>
            </div>
            <div class="login-input">
                <input type="text" id="reg-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="off">
            </div>
            <div class="login-input">
                <input type="email" id="reg-email" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" autocomplete="off">
            </div>
            <div class="login-input">
                <input type="password" id="reg-password" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="off">
            </div>
            <div class="login-input">
                <input type="password" id="reg-password2" placeholder="è¯·ç¡®è®¤å¯†ç " autocomplete="off">
            </div>
            <div class="login-input" style="display: flex; gap: 10px;">
                <input type="text" id="reg-verify" placeholder="è¯·è¾“å…¥éªŒè¯ç " style="flex: 1;">
                <button class="btn btn-purple" onclick="sendVerifyCode()" id="send-code-btn">å‘é€éªŒè¯ç </button>
            </div>
            <button class="login-btn" onclick="doTeacherRegister()">æ³¨ å†Œ</button>
            <div id="register-error" class="login-error"></div>
            <div id="register-tip" style="text-align: center; color: #64748b; font-size: 13px; margin-top: 15px; display: none;">
                <p>ğŸ“§ å‘ <strong style="color:#667eea;">2124224743@qq.com</strong> å‘é€é‚®ä»¶</p>
                <p style="margin-top:8px;">å†…å®¹å¡«å†™: <strong style="color:#EF4444;">1234</strong>ï¼Œå¯¹æ–¹å›å¤ <strong style="color:#10B981;">56</strong> åè¾“å…¥å³å¯</p>
            </div>
        </div>
    </div>
    
    <div id="student-login-screen" class="login-container hidden">
        <div class="login-card">
            <button class="back-btn" onclick="backToRoleSelect()">â† è¿”å›é€‰æ‹©èº«ä»½</button>
            <div class="login-icon">ğŸ‘¨â€ğŸ“</div>
            <div class="login-title">
                <h1>å­¦ç”Ÿç™»å½•</h1>
                <p>è¯·è¾“å…¥å­¦å·å’Œå¯†ç </p>
            </div>
            <div class="login-input">
                <input type="text" id="student-code" placeholder="è¯·è¾“å…¥å­¦å·" autocomplete="off">
            </div>
            <div class="login-input">
                <input type="password" id="student-password" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆé¦–æ¬¡ç™»å½•å³æ³¨å†Œï¼‰" autocomplete="off">
            </div>
            <button class="login-btn" onclick="doStudentLogin()">ç™» å½• / æ³¨ å†Œ</button>
            <div id="student-login-error" class="login-error"></div>
            <div style="text-align: center; margin-top: 15px; color: #64748b; font-size: 13px;">
                <p>é¦–æ¬¡ç™»å½•å°†è‡ªåŠ¨æ³¨å†Œè´¦å·</p>
                <p>å­¦å·éœ€ç”±è€å¸ˆå…ˆæ·»åŠ </p>
            </div>
        </div>
    </div>
    
    <div id="teacher-main" class="main-container">
        <div class="top-bar">
            <h1>ğŸ“‹ ç­çº§é€š - æ•™å¸ˆç«¯</h1>
            <div class="top-bar-right">
                <div class="user-avatar" id="teacher-avatar">å¸ˆ</div>
                <div class="user-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-header-name" id="teacher-dropdown-name">ç”¨æˆ·å</div>
                        <div class="dropdown-header-role">æ•™å¸ˆ</div>
                    </div>
                    <button class="dropdown-item" onclick="switchAccount()">ğŸ”„ åˆ‡æ¢è´¦å·</button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item danger" onclick="teacherLogout()">ğŸšª é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
        <div class="content-area">
            <div class="sidebar">
                <button class="sidebar-btn active" onclick="showTeacherScreen('student')"><span>ğŸ‘¥</span> å­¦ç”Ÿç®¡ç†</button>
                <button class="sidebar-btn" onclick="showTeacherScreen('class')"><span>ğŸ«</span> ç­çº§ç®¡ç†</button>
                <button class="sidebar-btn" onclick="showTeacherScreen('rollcall')"><span>ğŸ²</span> éšæœºç‚¹å</button>
                <button class="sidebar-btn" onclick="showTeacherScreen('attendance')"><span>âœ…</span> å­¦ç”Ÿç­¾åˆ°</button>
                <button class="sidebar-btn" onclick="showTeacherScreen('homework')"><span>ğŸ“š</span> å¸ƒç½®ä½œä¸š</button>
                <button class="sidebar-btn" onclick="showTeacherScreen('chat')"><span>ğŸ’¬</span> èŠå¤©ç®¡ç†</button>
                <button class="sidebar-btn" onclick="showTeacherScreen('score')"><span>â­</span> å­¦ç”Ÿæ‰“åˆ†</button>
                <button class="sidebar-btn" onclick="showTeacherScreen('call')"><span>ğŸ“¢</span> å«å·ç³»ç»Ÿ</button>
                <button class="sidebar-btn" onclick="showTeacherScreen('history')"><span>ğŸ“…</span> å†å²è®°å½•</button>
                <button class="sidebar-btn" onclick="showTeacherScreen('data')"><span>ğŸ’¾</span> æ•°æ®ç®¡ç†</button>
            </div>
            <div class="main-content" id="teacher-content"></div>
        </div>
    </div>
    
    <div id="student-main" class="main-container">
        <div class="top-bar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <h1>ğŸ“š ç­çº§é€š - å­¦ç”Ÿç«¯</h1>
            <div class="top-bar-right">
                <div class="user-avatar" id="student-avatar">ç”Ÿ</div>
                <div class="user-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-header-name" id="student-dropdown-name">ç”¨æˆ·å</div>
                        <div class="dropdown-header-role">å­¦ç”Ÿ</div>
                    </div>
                    <button class="dropdown-item" onclick="switchAccount()">ğŸ”„ åˆ‡æ¢è´¦å·</button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item danger" onclick="studentLogout()">ğŸšª é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
        <div class="content-area">
            <div class="sidebar student-sidebar">
                <button class="sidebar-btn active" onclick="showStudentScreen('home')"><span>ğŸ </span> é¦–é¡µ</button>
                <button class="sidebar-btn" onclick="showStudentScreen('myclass')"><span>ğŸ«</span> æˆ‘çš„ç­çº§</button>
                <button class="sidebar-btn" onclick="showStudentScreen('call')" style="position:relative;"><span>ğŸ“¢</span> å«å·é€šçŸ¥<span class="notification-badge" id="call-badge">æ–°</span></button>
                <button class="sidebar-btn" onclick="showStudentScreen('homework')"><span>ğŸ“š</span> æˆ‘çš„ä½œä¸š</button>
                <button class="sidebar-btn" onclick="showStudentScreen('chat')"><span>ğŸ’¬</span> èŠå¤©</button>
                <button class="sidebar-btn" onclick="showStudentScreen('score')"><span>â­</span> æˆ‘çš„æˆç»©</button>
                <button class="sidebar-btn" onclick="showStudentScreen('attendance')"><span>âœ…</span> ç­¾åˆ°</button>
            </div>
            <div class="main-content" id="student-content"></div>
        </div>
    </div>
    
    <div id="batch-modal" class="modal"><div class="modal-card"><div class="modal-title">ğŸ“¥ æ‰¹é‡å¯¼å…¥å­¦ç”Ÿ</div><div class="form-group"><label>å­¦ç”Ÿåˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šå§“å,å­¦å·ï¼‰</label><textarea id="batch-input" style="width:100%; height:250px; resize:none;" placeholder="å¼ ä¸‰,202400000001&#10;æå››&#10;ç‹äº”,202400000003"></textarea></div><div class="btn-group"><button class="btn btn-purple" onclick="doBatchImport()">ç¡®è®¤å¯¼å…¥</button><button class="btn btn-warning" onclick="hideModal('batch-modal')">å–æ¶ˆ</button></div></div></div>
    <div id="batch-assign-modal" class="modal"><div class="modal-card" style="max-width:650px;"><div class="modal-title">ğŸ“¦ æ‰¹é‡åˆ†é…ç­çº§</div><div class="form-group"><label>é€‰æ‹©å­¦ç”Ÿï¼ˆå‹¾é€‰è¦åˆ†é…çš„å­¦ç”Ÿï¼‰</label><div class="table-container" style="max-height:300px;"><table class="student-table"><thead><tr><th><input type="checkbox" onchange="toggleBatchAssignAll(this.checked)"></th><th>å§“å</th><th>å­¦å·</th><th>å½“å‰ç­çº§</th></tr></thead><tbody id="batch-assign-student-list"></tbody></table></div></div><div class="form-group"><label>åˆ†é…åˆ°ç­çº§</label><select id="batch-assign-class" style="width:100%;"><option value="">é€‰æ‹©ç­çº§</option></select></div><div class="btn-group"><button class="btn btn-success" onclick="doBatchAssign()">ç¡®è®¤åˆ†é…</button><button class="btn btn-warning" onclick="hideModal('batch-assign-modal')">å–æ¶ˆ</button></div></div></div>
    <div id="chat-modal" class="modal"><div class="modal-card" style="max-width:500px;height:80vh;display:flex;flex-direction:column;"><div class="modal-title" style="display:flex;justify-content:space-between;align-items:center;"><span>ğŸ’¬ ä¸ <span id="chat-modal-friend-name"></span> çš„èŠå¤©</span><div style="display:flex;gap:10px;"><button class="btn btn-primary btn-small" onclick="clearChatHistory()">æ¸…ç©ºè®°å½•</button><button class="btn btn-warning btn-small" onclick="hideModal('chat-modal')">å…³é—­</button></div></div><input type="hidden" id="chat-modal-friend-code"><div style="margin-bottom:10px;"><div class="form-row" style="gap:10px;"><input type="text" id="chat-search" placeholder="æœç´¢èŠå¤©è®°å½•..." style="flex:1;"><button class="btn btn-primary btn-small" onclick="searchChat()">æœç´¢</button><button class="btn btn-warning btn-small" onclick="clearSearch()" style="display:none;" id="clear-search-btn">æ¸…ç©º</button></div></div><div id="chat-messages" class="chat-container"></div><div class="chat-input-area"><input type="text" id="chat-input" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')sendChatMessage()" onfocus="this.select()" onclick="this.focus()"><button class="chat-send-btn" onclick="sendChatMessage()">å‘é€</button></div></div></div>
    <div id="homework-modal" class="modal"><div class="modal-card"><div class="modal-title">ğŸ“š å¸ƒç½®æ–°ä½œä¸š</div><div class="form-group"><label>ä½œä¸šæ ‡é¢˜</label><input type="text" id="homework-title" placeholder="è¯·è¾“å…¥ä½œä¸šæ ‡é¢˜"></div><div class="form-group"><label>ä½œä¸šå†…å®¹</label><textarea id="homework-content" style="width:100%; height:150px; resize:none;" placeholder="è¯·è¾“å…¥ä½œä¸šå†…å®¹"></textarea></div><div class="form-group"><label>æˆªæ­¢æ—¥æœŸ</label><input type="date" id="homework-deadline"></div><div class="btn-group"><button class="btn btn-success" onclick="saveHomework()">å‘å¸ƒä½œä¸š</button><button class="btn btn-warning" onclick="hideModal('homework-modal')">å–æ¶ˆ</button></div></div></div>
    <div id="message-modal" class="modal"><div class="modal-card"><div class="modal-title">ğŸ’¬ å‘é€æ¶ˆæ¯</div><div class="form-group"><label>æ¥æ”¶å¯¹è±¡</label><select id="message-target" style="width:100%;"><option value="all">å…¨ä½“å­¦ç”Ÿ</option></select></div><div class="form-group"><label>æ¶ˆæ¯å†…å®¹</label><textarea id="message-content" style="width:100%; height:150px; resize:none;" placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹"></textarea></div><div class="btn-group"><button class="btn btn-success" onclick="sendMessage()">å‘é€æ¶ˆæ¯</button><button class="btn btn-warning" onclick="hideModal('message-modal')">å–æ¶ˆ</button></div></div></div>
    <div id="score-modal" class="modal"><div class="modal-card"><div class="modal-title">â­ ä¸º <span id="score-modal-name"></span> æ‰“åˆ†</div><div class="form-group"><label>è¯„åˆ†ç±»å‹</label><select id="score-type" style="width:100%;"><option value="å¹³æ—¶æˆç»©">å¹³æ—¶æˆç»©</option><option value="ä½œä¸šæˆç»©">ä½œä¸šæˆç»©</option><option value="è€ƒè¯•æˆç»©">è€ƒè¯•æˆç»©</option><option value="è¯¾å ‚è¡¨ç°">è¯¾å ‚è¡¨ç°</option><option value="å…¶ä»–">å…¶ä»–</option></select></div><div class="form-group"><label>åˆ†æ•° (0-100)</label><input type="number" id="score-value" placeholder="è¯·è¾“å…¥åˆ†æ•°" min="0" max="100" style="width:100%;"></div><div class="form-group"><label>å¤‡æ³¨è¯´æ˜ï¼ˆå¯é€‰ï¼‰</label><input type="text" id="score-remark" placeholder="è¯·è¾“å…¥å¤‡æ³¨" style="width:100%;"></div><div class="btn-group"><button class="btn btn-success" onclick="submitScore()">ç¡®è®¤æ‰“åˆ†</button><button class="btn btn-warning" onclick="hideModal('score-modal')">å–æ¶ˆ</button></div></div></div>
    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
    
    <script>
        const VERIFY_CODE = '56';
        let verifyCodeSent = false;
        let selectedRole = 'teacher';
        let users = [];
        let students = [];
        let attendanceRecords = {};
        let attendedStudents = [];
        let selectedStudents = new Set();
        let isAnimating = false;
        let homeworks = [];
        let messages = [];
        let friends = [];
        let scores = [];
        let callQueue = [];
        let callRecords = [];
        let currentScoreStudent = null;
        let currentStudent = null;
        let callCheckInterval = null;
        let classes = [];
        let friendRequests = [];
        let chatMessages = {};
        let currentAttendanceCode = '';
        
        function loadUsers() {
            const saved = localStorage.getItem('teacherUsers');
            if (saved) users = JSON.parse(saved);
            if (!users.some(u => u.username === 'liuketing')) {
                users.push({username: 'liuketing', password: '080213'});
                saveUsers();
            }
        }
        function saveUsers() { localStorage.setItem('teacherUsers', JSON.stringify(users)); }
        function loadData() {
            let saved = localStorage.getItem('banJiTongData');
            if (!saved) {
                saved = localStorage.getItem('studentRollCallData');
                if (saved) {
                    localStorage.setItem('banJiTongData', saved);
                    localStorage.removeItem('studentRollCallData');
                }
            }
            if (saved) {
                const data = JSON.parse(saved);
                students = data.students || [];
                attendanceRecords = data.attendanceRecords || data.attendance || {};
                homeworks = data.homeworks || [];
                messages = data.messages || [];
                friends = data.friends || [];
                scores = data.scores || [];
                callQueue = data.callQueue || [];
                callRecords = data.callRecords || [];
                classes = data.classes || [];
                friendRequests = data.friendRequests || [];
                chatMessages = data.chatMessages || {};
            }
        }
        function saveData() {
            localStorage.setItem('banJiTongData', JSON.stringify({
                students, attendanceRecords, homeworks, messages, friends, scores, callQueue, callRecords, classes, friendRequests, chatMessages
            }));
        }
        function getStudentAccounts() { return JSON.parse(localStorage.getItem('studentAccounts') || '{}'); }
        function saveStudentAccounts(acc) { localStorage.setItem('studentAccounts', JSON.stringify(acc)); }
        
        function selectRole(role) {
            selectedRole = role;
            document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.role-btn').classList.add('active');
        }
        function goToLogin() {
            document.getElementById('role-select-screen').classList.add('hidden');
            if (selectedRole === 'teacher') {
                document.getElementById('teacher-login-screen').classList.remove('hidden');
            } else {
                document.getElementById('student-login-screen').classList.remove('hidden');
            }
        }
        function backToRoleSelect() {
            document.getElementById('teacher-login-screen').classList.add('hidden');
            document.getElementById('student-login-screen').classList.add('hidden');
            document.getElementById('role-select-screen').classList.remove('hidden');
        }
        function backToTeacherLogin() {
            document.getElementById('teacher-register-screen').classList.add('hidden');
            document.getElementById('teacher-login-screen').classList.remove('hidden');
        }
        function showTeacherRegister() {
            document.getElementById('teacher-login-screen').classList.add('hidden');
            document.getElementById('teacher-register-screen').classList.remove('hidden');
            document.getElementById('reg-username').value = '';
            document.getElementById('reg-email').value = '';
            document.getElementById('reg-password').value = '';
            document.getElementById('reg-password2').value = '';
            document.getElementById('reg-verify').value = '';
            document.getElementById('register-error').style.display = 'none';
            document.getElementById('register-tip').style.display = 'none';
            verifyCodeSent = false;
            document.getElementById('send-code-btn').textContent = 'å‘é€éªŒè¯ç ';
            document.getElementById('send-code-btn').disabled = false;
        }
        function sendVerifyCode() {
            document.getElementById('register-tip').style.display = 'block';
            document.getElementById('send-code-btn').textContent = 'å·²å‘é€';
            document.getElementById('send-code-btn').disabled = true;
            verifyCodeSent = true;
            alert('éªŒè¯æç¤ºå·²æ˜¾ç¤ºï¼\n\nè¯·å‘ 2124224743@qq.com å‘é€é‚®ä»¶å†…å®¹ "1234"\nå¯¹æ–¹å›å¤ "56" åï¼Œè¾“å…¥ 56 å³å¯æ³¨å†Œã€‚');
        }
        function doTeacherRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const password2 = document.getElementById('reg-password2').value;
            const verify = document.getElementById('reg-verify').value.trim();
            if (!username) { document.getElementById('register-error').textContent = 'è¯·è¾“å…¥ç”¨æˆ·åï¼'; document.getElementById('register-error').style.display = 'block'; return; }
            if (username.length < 2) { document.getElementById('register-error').textContent = 'ç”¨æˆ·åè‡³å°‘2ä¸ªå­—ç¬¦ï¼'; document.getElementById('register-error').style.display = 'block'; return; }
            if (users.some(u => u.username === username)) { document.getElementById('register-error').textContent = 'ç”¨æˆ·åå·²å­˜åœ¨ï¼'; document.getElementById('register-error').style.display = 'block'; return; }
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { document.getElementById('register-error').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€ï¼'; document.getElementById('register-error').style.display = 'block'; return; }
            if (users.some(u => u.email === email)) { document.getElementById('register-error').textContent = 'è¯¥é‚®ç®±å·²è¢«æ³¨å†Œï¼'; document.getElementById('register-error').style.display = 'block'; return; }
            if (!password || password.length < 4) { document.getElementById('register-error').textContent = 'å¯†ç è‡³å°‘4ä¸ªå­—ç¬¦ï¼'; document.getElementById('register-error').style.display = 'block'; return; }
            if (password !== password2) { document.getElementById('register-error').textContent = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´ï¼'; document.getElementById('register-error').style.display = 'block'; return; }
            if (!verifyCodeSent) { document.getElementById('register-error').textContent = 'è¯·å…ˆå‘é€éªŒè¯ç ï¼'; document.getElementById('register-error').style.display = 'block'; return; }
            if (verify !== VERIFY_CODE) { document.getElementById('register-error').textContent = 'éªŒè¯ç é”™è¯¯ï¼'; document.getElementById('register-error').style.display = 'block'; return; }
            users.push({username, email, password});
            saveUsers();
            alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚');
            backToTeacherLogin();
            document.getElementById('teacher-username').value = username;
        }
        function doTeacherLogin() {
            loadUsers();
            const username = document.getElementById('teacher-username').value.trim();
            const password = document.getElementById('teacher-password').value;
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                sessionStorage.setItem('teacherLoggedIn', 'true');
                sessionStorage.setItem('currentUser', username);
                document.getElementById('teacher-login-screen').classList.add('hidden');
                document.getElementById('teacher-main').classList.add('active');
                document.getElementById('teacher-dropdown-name').textContent = username;
                document.getElementById('teacher-avatar').textContent = username.charAt(0);
                loadData();
                updateAllTeacherViews();
            } else {
                document.getElementById('teacher-login-error').style.display = 'block';
            }
        }
        
        function syncAttendanceRecords() {
            // åŒæ­¥å­¦ç”Ÿç«¯çš„ç­¾åˆ°è®°å½•åˆ°æ•™å¸ˆç«¯æ˜¾ç¤º
            const today = new Date().toISOString().split('T')[0];
            attendedStudents = attendanceRecords[today] || [];
            updateAttendanceStats();
            updateAttendedList();
        }
        function doStudentLogin() {
            loadData();
            const code = document.getElementById('student-code').value.trim();
            const password = document.getElementById('student-password').value;
            if (!code) { document.getElementById('student-login-error').textContent = 'è¯·è¾“å…¥å­¦å·ï¼'; document.getElementById('student-login-error').style.display = 'block'; return; }
            if (!password) { document.getElementById('student-login-error').textContent = 'è¯·è¾“å…¥å¯†ç ï¼'; document.getElementById('student-login-error').style.display = 'block'; return; }
            const student = students.find(s => s.code === code);
            if (!student) { document.getElementById('student-login-error').textContent = 'å­¦å·ä¸å­˜åœ¨ï¼Œè¯·è”ç³»è€å¸ˆæ·»åŠ ï¼'; document.getElementById('student-login-error').style.display = 'block'; return; }
            const accounts = getStudentAccounts();
            if (accounts[code] && accounts[code] !== password) { document.getElementById('student-login-error').textContent = 'å¯†ç é”™è¯¯ï¼'; document.getElementById('student-login-error').style.display = 'block'; return; }
            if (!accounts[code]) { accounts[code] = password; saveStudentAccounts(accounts); }
            currentStudent = {code, name: student.name};
            sessionStorage.setItem('studentLoggedIn', 'true');
            sessionStorage.setItem('currentStudent', JSON.stringify(currentStudent));
            document.getElementById('student-login-screen').classList.add('hidden');
            document.getElementById('student-main').classList.add('active');
            document.getElementById('student-dropdown-name').textContent = student.name;
            document.getElementById('student-avatar').textContent = student.name.charAt(0);
            updateAllStudentViews();
            startCallCheck();
        }
        function teacherLogout() {
            sessionStorage.removeItem('teacherLoggedIn');
            sessionStorage.removeItem('currentUser');
            document.getElementById('teacher-main').classList.remove('active');
            document.getElementById('role-select-screen').classList.remove('hidden');
            document.getElementById('teacher-username').value = '';
            document.getElementById('teacher-password').value = '';
        }
        function studentLogout() {
            sessionStorage.removeItem('studentLoggedIn');
            sessionStorage.removeItem('currentStudent');
            currentStudent = null;
            if (callCheckInterval) clearInterval(callCheckInterval);
            document.getElementById('student-main').classList.remove('active');
            document.getElementById('role-select-screen').classList.remove('hidden');
            document.getElementById('student-code').value = '';
            document.getElementById('student-password').value = '';
        }
        
        document.getElementById('teacher-password').addEventListener('keypress', e => { if (e.key === 'Enter') doTeacherLogin(); });
        document.getElementById('student-password').addEventListener('keypress', e => { if (e.key === 'Enter') doStudentLogin(); });
        document.getElementById('reg-password2').addEventListener('keypress', e => { if (e.key === 'Enter') doTeacherRegister(); });
        
        function checkSession() {
            loadUsers();
            loadData();
            const teacherLoggedIn = sessionStorage.getItem('teacherLoggedIn');
            const teacherUser = sessionStorage.getItem('currentUser');
            if (teacherLoggedIn === 'true' && teacherUser) {
                document.getElementById('role-select-screen').classList.add('hidden');
                document.getElementById('teacher-main').classList.add('active');
                document.getElementById('teacher-dropdown-name').textContent = teacherUser;
                document.getElementById('teacher-avatar').textContent = teacherUser.charAt(0);
                updateAllTeacherViews();
                return;
            }
            const studentLoggedIn = sessionStorage.getItem('studentLoggedIn');
            const studentData = sessionStorage.getItem('currentStudent');
            if (studentLoggedIn === 'true' && studentData) {
                currentStudent = JSON.parse(studentData);
                document.getElementById('role-select-screen').classList.add('hidden');
                document.getElementById('student-main').classList.add('active');
                document.getElementById('student-dropdown-name').textContent = currentStudent.name;
                document.getElementById('student-avatar').textContent = currentStudent.name.charAt(0);
                updateAllStudentViews();
                startCallCheck();
            }
        }
        function switchAccount() {
            sessionStorage.clear();
            document.getElementById('teacher-main').classList.remove('active');
            document.getElementById('student-main').classList.remove('active');
            document.getElementById('role-select-screen').classList.remove('hidden');
            document.getElementById('teacher-username').value = '';
            document.getElementById('teacher-password').value = '';
            document.getElementById('student-code').value = '';
            document.getElementById('student-password').value = '';
            if (callCheckInterval) clearInterval(callCheckInterval);
        }
        
        function hideModal(id) { document.getElementById(id).classList.remove('active'); }
        function speakText(text) { if ('speechSynthesis' in window) { speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'zh-CN'; u.rate = 0.9; speechSynthesis.speak(u); } }
        
        // Teacher functions
        function showTeacherScreen(screen) {
            document.querySelectorAll('#teacher-main .sidebar-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#teacher-main .sidebar-btn').forEach(b => { if (b.textContent.includes({'student':'å­¦ç”Ÿç®¡ç†','class':'ç­çº§ç®¡ç†','rollcall':'éšæœºç‚¹å','attendance':'å­¦ç”Ÿç­¾åˆ°','homework':'å¸ƒç½®ä½œä¸š','chat':'èŠå¤©ç®¡ç†','message':'å‘é€æ¶ˆæ¯','friend':'å¥½å‹ç®¡ç†','score':'å­¦ç”Ÿæ‰“åˆ†','call':'å«å·ç³»ç»Ÿ','history':'å†å²è®°å½•','data':'æ•°æ®ç®¡ç†'}[screen])) b.classList.add('active'); });
            event.target.closest('.sidebar-btn').classList.add('active');
            renderTeacherScreen(screen);
            if (screen === 'attendance') initAttendance();
        }
        function renderTeacherScreen(screen) {
            const content = document.getElementById('teacher-content');
            const screens = {
                student: `<div class="card"><div class="card-title">ğŸ‘¥ å­¦ç”Ÿç®¡ç†</div><div class="form-row"><input type="text" id="student-name" placeholder="å­¦ç”Ÿå§“å" style="flex:1;"><input type="text" id="student-code" placeholder="å­¦å·ï¼ˆ12ä½ï¼Œå¯è‡ªåŠ¨ç”Ÿæˆï¼‰" style="flex:1.5;"><select id="student-class" style="flex:1;"><option value="">é€‰æ‹©ç­çº§</option></select><button class="btn btn-success" onclick="addStudent()">æ·»åŠ å­¦ç”Ÿ</button><button class="btn btn-purple" onclick="showBatchImport()">ğŸ“¥ æ‰¹é‡å¯¼å…¥</button></div><div class="table-container"><table class="student-table"><thead><tr><th><input type="checkbox" onchange="toggleAll(this.checked)"></th><th>åºå·</th><th>å§“å</th><th>å­¦å·</th><th>ç­çº§</th><th>æ“ä½œ</th></tr></thead><tbody id="student-list"></tbody></table></div><div class="form-row" style="margin-top:20px;"><button class="btn btn-danger" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­</button><button class="btn btn-warning" onclick="clearAllStudents()">æ¸…ç©ºåå•</button></div></div>`,
                class: `<div class="card"><div class="card-title">ğŸ« ç­çº§ç®¡ç†</div><div class="form-row"><input type="text" id="class-name" placeholder="ç­çº§åç§°ï¼ˆå¦‚ï¼šé«˜ä¸€1ç­ï¼‰" style="flex:1;"><input type="text" id="class-code" placeholder="ç­çº§ä»£ç ï¼ˆå¦‚ï¼šG11ï¼‰" style="flex:0.5;"><button class="btn btn-success" onclick="addClass()">æ·»åŠ ç­çº§</button></div><div class="table-container"><table class="student-table"><thead><tr><th>åºå·</th><th>ç­çº§åç§°</th><th>ç­çº§ä»£ç </th><th>å­¦ç”Ÿäººæ•°</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody id="class-list"></tbody></table></div></div><div class="card"><div class="card-title">ğŸ“¦ æ‰¹é‡åˆ†é…ç­çº§</div><p class="tip-text">é€‰æ‹©å¤šä¸ªå­¦ç”Ÿå¹¶æ‰¹é‡åˆ†é…åˆ°æŒ‡å®šç­çº§</p><div class="form-row"><select id="batch-target-class" style="flex:1;"><option value="">é€‰æ‹©ç›®æ ‡ç­çº§</option></select><button class="btn btn-primary" onclick="showBatchAssignModal()">æ‰¹é‡åˆ†é…</button></div></div><div class="card"><div class="card-title">ğŸ”„ å•ä¸ªå­¦ç”Ÿè°ƒæ•´</div><p class="tip-text">é€‰æ‹©å­¦ç”Ÿå¹¶ä¿®æ”¹å…¶æ‰€å±ç­çº§</p><div class="form-row"><select id="move-student" style="flex:1;"><option value="">é€‰æ‹©å­¦ç”Ÿ</option></select><select id="move-class" style="flex:1;"><option value="">é€‰æ‹©ç›®æ ‡ç­çº§</option></select><button class="btn btn-primary" onclick="moveStudentClass()">ç¡®è®¤è°ƒæ•´</button></div></div><div class="card"><div class="card-title">ğŸ”‘ é‡ç½®å­¦ç”Ÿå¯†ç </div><p class="tip-text">é€‰æ‹©å­¦ç”Ÿåé‡ç½®å…¶ç™»å½•å¯†ç </p><div class="form-row"><select id="reset-student" style="flex:1;"><option value="">é€‰æ‹©å­¦ç”Ÿ</option></select><input type="text" id="new-password" placeholder="æ–°å¯†ç " style="flex:0.5;"><button class="btn btn-warning" onclick="resetStudentPassword()">é‡ç½®å¯†ç </button></div></div>`,
                rollcall: `<div class="card"><div class="card-title">ğŸ² éšæœºç‚¹å</div><div class="form-row"><span style="padding:14px;font-weight:bold;color:#475569;">ç‚¹åäººæ•°ï¼š</span><input type="number" id="roll-num" value="1" min="1" style="width:100px;"><select id="roll-class" style="flex:1;"><option value="">å…¨éƒ¨ç­çº§</option></select><button class="btn btn-primary" onclick="randomRollCall()">ğŸ² å¼€å§‹ç‚¹å</button></div><div class="roll-display"><div class="roll-result" id="roll-result">ç‚¹å‡»å¼€å§‹ç‚¹å</div><div class="roll-info" id="roll-info"></div></div></div>`,
                attendance: `<div class="card"><div class="card-title">âœ… å­¦ç”Ÿç­¾åˆ°</div><div class="stats-grid" id="attendance-stats"></div><div class="form-row"><input type="text" id="attendance-check-code" placeholder="ç­¾åˆ°ç ï¼ˆ6ä½æ•°å­—ï¼‰" style="flex:0.5;"><button class="btn btn-primary" onclick="setAttendanceCode()">è®¾ç½®ç­¾åˆ°ç </button><input type="text" id="attendance-code" placeholder="è¯·è¾“å…¥å­¦å·ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰" style="flex:1;"><button class="btn btn-success" onclick="checkCode()">ç­¾åˆ°</button><button class="btn btn-warning" onclick="syncAttendanceRecords()">ğŸ”„ åŒæ­¥è®°å½•</button></div><div class="table-container"><table class="student-table"><thead><tr><th>åºå·</th><th>å§“å</th><th>å­¦å·</th><th>ç­¾åˆ°æ—¶é—´</th></tr></thead><tbody id="attended-list"></tbody></table></div><div class="form-row" style="margin-top:20px;"><button class="btn btn-primary" onclick="finishAttendance()">å®Œæˆç­¾åˆ°</button></div></div>`,
                homework: `<div class="card"><div class="card-title">ğŸ“š å¸ƒç½®ä½œä¸š</div><div class="form-row"><button class="btn btn-primary" onclick="showAddHomework()">â• å¸ƒç½®æ–°ä½œä¸š</button></div><div id="homework-list"></div></div>`,
                chat: `<div class="card"><div class="card-title">ğŸ’¬ èŠå¤©ç®¡ç†</div><div class="form-row"><button class="btn btn-primary" onclick="showSendMessage()">â• å‘é€ç³»ç»Ÿæ¶ˆæ¯</button></div><div id="message-list"></div></div><div class="card"><div class="card-title">ğŸ¤ å¥½å‹ç®¡ç†</div><div class="form-row"><input type="text" id="friend-name" placeholder="å¥½å‹å§“å" style="flex:1;"><input type="text" id="friend-account" placeholder="å¥½å‹è´¦å·" style="flex:1;"><button class="btn btn-success" onclick="addFriend()">æ·»åŠ å¥½å‹</button></div><div id="friend-list"></div></div>`,
                score: `<div class="card"><div class="card-title">â­ å­¦ç”Ÿæ‰“åˆ†ç³»ç»Ÿ</div><p class="tip-text">ç‚¹å‡»å­¦ç”Ÿå§“åè¿›è¡Œæ‰“åˆ†</p><div class="table-container"><table class="student-table"><thead><tr><th>åºå·</th><th>å§“å</th><th>å­¦å·</th><th>å¹³å‡åˆ†</th><th>æ‰“åˆ†æ¬¡æ•°</th><th>æ“ä½œ</th></tr></thead><tbody id="score-student-list"></tbody></table></div></div><div class="card"><div class="card-title">ğŸ“‹ æœ€è¿‘æ‰“åˆ†è®°å½•</div><div class="table-container"><table class="student-table"><thead><tr><th>åºå·</th><th>å§“å</th><th>å­¦å·</th><th>è¯„åˆ†ç±»å‹</th><th>åˆ†æ•°</th><th>å¤‡æ³¨</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody id="score-list"></tbody></table></div></div><div class="card"><div class="card-title">ğŸ“Š æˆç»©ç»Ÿè®¡</div><div class="stats-grid" id="score-stats"></div><div class="form-row"><select id="stats-student" style="flex:1;" onchange="showStudentScoreDetail()"><option value="">é€‰æ‹©å­¦ç”ŸæŸ¥çœ‹è¯¦æƒ…</option></select><button class="btn btn-primary" onclick="exportScores()">ğŸ“¤ å¯¼å‡ºæˆç»©</button></div><div id="score-detail"></div></div>`,
                message: `<div class="card"><div class="card-title">ğŸ’¬ å‘é€æ¶ˆæ¯</div><div class="form-row"><button class="btn btn-primary" onclick="showSendMessage()">â• å‘é€æ–°æ¶ˆæ¯</button></div><div id="message-list"></div></div>`,
                friend: `<div class="card"><div class="card-title">ğŸ¤ å¥½å‹ç®¡ç†</div><div class="form-row"><input type="text" id="friend-name" placeholder="å¥½å‹å§“å" style="flex:1;"><input type="text" id="friend-account" placeholder="å¥½å‹è´¦å·" style="flex:1;"><button class="btn btn-success" onclick="addFriend()">æ·»åŠ å¥½å‹</button></div><div id="friend-list"></div></div>`,
                call: `<div class="card"><div class="card-title">ğŸ“¢ å«å·ç³»ç»Ÿ - å‘¼å«å­¦ç”Ÿæ¥åŠå…¬å®¤</div><div class="form-row"><input type="text" id="call-task" placeholder="è¯·è¾“å…¥ä»»åŠ¡ï¼ˆå¦‚ï¼šæ¥åŠå…¬å®¤ä¸€è¶Ÿï¼‰" style="flex:1;" value="æ¥åŠå…¬å®¤ä¸€è¶Ÿ"></div><div class="form-row"><button class="btn btn-primary" onclick="randomCallStudent()" style="flex:1;font-size:18px;padding:18px;">ğŸ² éšæœºå«å·</button><button class="btn btn-success" onclick="callNextInQueue()" style="flex:1;font-size:18px;padding:18px;">ğŸ“‹ å«ä¸‹ä¸€ä½æ’é˜Ÿ</button></div><div class="roll-display" style="min-height:120px;"><div class="roll-result" id="call-result" style="font-size:42px;">ç‚¹å‡»å«å·</div><div class="roll-info" id="call-info"></div><div id="call-task-display" style="margin-top:10px;font-size:18px;color:#667eea;font-weight:bold;"></div></div><div class="form-row"><select id="call-student" style="flex:1;"><option value="">é€‰æ‹©å­¦ç”Ÿæ‰‹åŠ¨å‘¼å«</option></select><button class="btn btn-warning" onclick="callSelectedStudent()">ğŸ“¢ å‘¼å«</button></div></div><div class="card"><div class="card-title">ğŸ“‹ æ’é˜Ÿç­‰å€™åŒº</div><p style="color:#64748b;margin-bottom:15px;">å­¦ç”Ÿåˆ°è¾¾åç‚¹å‡»"å·²åˆ°è¾¾"ç§»å‡ºé˜Ÿåˆ—</p><div class="table-container"><table class="student-table"><thead><tr><th>åºå·</th><th>å§“å</th><th>å­¦å·</th><th>ä»»åŠ¡</th><th>å‘¼å«æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody id="call-queue-list"></tbody></table></div></div><div class="card"><div class="card-title">ğŸ“œ å«å·è®°å½•</div><div class="stats-grid"><div class="stat-card"><div class="stat-num" id="call-total">0</div><div class="stat-label">ä»Šæ—¥å«å·</div></div><div class="stat-card"><div class="stat-num" style="color:#10B981;" id="call-arrived">0</div><div class="stat-label">å·²åˆ°è¾¾</div></div><div class="stat-card"><div class="stat-num" style="color:#EF4444;" id="call-waiting">0</div><div class="stat-label">ç­‰å¾…ä¸­</div></div></div><div class="table-container"><table class="student-table"><thead><tr><th>åºå·</th><th>å§“å</th><th>å­¦å·</th><th>ä»»åŠ¡</th><th>å‘¼å«æ—¶é—´</th><th>çŠ¶æ€</th></tr></thead><tbody id="call-history-list"></tbody></table></div></div>`,
                history: `<div class="card"><div class="card-title">ğŸ“… ç­¾åˆ°å†å²</div><div id="history-list"></div></div>`,
                data: `<div class="card"><div class="card-title">ğŸ’¾ æ•°æ®ç®¡ç†</div><div class="two-column"><div class="stat-card"><div class="stat-num" id="data-students">0</div><div class="stat-label">å­¦ç”Ÿæ€»æ•°</div></div><div class="stat-card"><div class="stat-num" id="data-records">0</div><div class="stat-label">ç­¾åˆ°è®°å½•</div></div></div><div class="form-row"><button class="btn btn-primary" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ‰€æœ‰æ•°æ®</button><button class="btn btn-success" onclick="document.getElementById('import-file').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button></div></div>`
            };
            content.innerHTML = screens[screen] || '';
            updateTeacherLists();
        }
        function updateAllTeacherViews() { renderTeacherScreen('student'); updateTeacherLists(); }
        function updateTeacherLists() {
            updateStudentList();
            updateClassList();
            updateClassSelects();
            updateAttendanceStats();
            updateAttendedList();
            updateHomeworkList();
            updateMessageList();
            updateFriendList();
            updateScoreStudentList();
            updateScoreList();
            updateScoreStats();
            updateCallStudentSelect();
            updateCallQueueList();
            updateCallHistoryList();
            updateCallStats();
            updateHistoryList();
            updateDataStats();
            updateMessageTargets();
        }
        function addClass() {
            const name = document.getElementById('class-name').value.trim();
            const code = document.getElementById('class-code').value.trim();
            if (!name) { alert('è¯·è¾“å…¥ç­çº§åç§°ï¼'); return; }
            if (!code) { alert('è¯·è¾“å…¥ç­çº§ä»£ç ï¼'); return; }
            if (classes.some(c => c.code === code)) { alert('ç­çº§ä»£ç å·²å­˜åœ¨ï¼'); return; }
            classes.push({id: Date.now(), name, code, createTime: new Date().toLocaleString()});
            saveData(); updateClassList(); updateClassSelects();
            document.getElementById('class-name').value = '';
            document.getElementById('class-code').value = '';
            alert('ç­çº§æ·»åŠ æˆåŠŸï¼');
        }
        function updateClassList() {
            const list = document.getElementById('class-list');
            if (!list) return;
            list.innerHTML = '';
            if (classes.length === 0) { list.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#94A3B8;">æš‚æ— ç­çº§ï¼Œè¯·æ·»åŠ </td></tr>'; return; }
            classes.forEach((c, i) => {
                const studentCount = students.filter(s => s.classCode === c.code).length;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i+1}</td><td style="color:#667eea;font-weight:bold;">${c.name}</td><td>${c.code}</td><td>${studentCount} äºº</td><td>${c.createTime}</td><td><button class="btn btn-danger btn-small" onclick="deleteClass(${c.id})">åˆ é™¤</button></td>`;
                list.appendChild(tr);
            });
        }
        function deleteClass(id) {
            const cls = classes.find(c => c.id === id);
            if (!cls) return;
            const studentCount = students.filter(s => s.classCode === cls.code).length;
            if (studentCount > 0) { alert('è¯¥ç­çº§ä¸‹è¿˜æœ‰å­¦ç”Ÿï¼Œè¯·å…ˆè°ƒæ•´å­¦ç”Ÿç­çº§ï¼'); return; }
            if (confirm('ç¡®å®šåˆ é™¤ç­çº§ "' + cls.name + '"ï¼Ÿ')) {
                classes = classes.filter(c => c.id !== id);
                saveData(); updateClassList(); updateClassSelects();
            }
        }
        function updateClassSelects() {
            const selects = ['student-class', 'move-class', 'roll-class', 'batch-target-class', 'batch-assign-class'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                const currentValue = select.value;
                if (id === 'roll-class') {
                    select.innerHTML = '<option value="">å…¨éƒ¨ç­çº§</option>';
                } else {
                    select.innerHTML = '<option value="">é€‰æ‹©ç­çº§</option>';
                }
                classes.forEach(c => { select.innerHTML += `<option value="${c.code}">${c.name}</option>`; });
                select.value = currentValue;
            });
            const moveStudentSelect = document.getElementById('move-student');
            const resetStudentSelect = document.getElementById('reset-student');
            if (moveStudentSelect) {
                moveStudentSelect.innerHTML = '<option value="">é€‰æ‹©å­¦ç”Ÿ</option>';
                students.forEach(s => {
                    const className = classes.find(c => c.code === s.classCode)?.name || 'æœªåˆ†é…';
                    moveStudentSelect.innerHTML += `<option value="${s.code}">${s.name} (${className})</option>`;
                });
            }
            if (resetStudentSelect) {
                resetStudentSelect.innerHTML = '<option value="">é€‰æ‹©å­¦ç”Ÿ</option>';
                students.forEach(s => { resetStudentSelect.innerHTML += `<option value="${s.code}">${s.name} - ${s.code}</option>`; });
            }
        }
        function moveStudentClass() {
            const studentCode = document.getElementById('move-student').value;
            const classCode = document.getElementById('move-class').value;
            if (!studentCode) { alert('è¯·é€‰æ‹©å­¦ç”Ÿï¼'); return; }
            const student = students.find(s => s.code === studentCode);
            if (!student) { alert('å­¦ç”Ÿä¸å­˜åœ¨ï¼'); return; }
            const oldClass = classes.find(c => c.code === student.classCode)?.name || 'æœªåˆ†é…';
            const newClass = classCode ? (classes.find(c => c.code === classCode)?.name || 'æœªçŸ¥') : 'æœªåˆ†é…';
            student.classCode = classCode || '';
            saveData(); updateStudentList(); updateClassList(); updateClassSelects();
            alert(`å·²å°† ${student.name} ä» "${oldClass}" è°ƒæ•´åˆ° "${newClass}"`);
        }
        function resetStudentPassword() {
            const studentCode = document.getElementById('reset-student').value;
            const newPassword = document.getElementById('new-password').value.trim();
            if (!studentCode) { alert('è¯·é€‰æ‹©å­¦ç”Ÿï¼'); return; }
            if (!newPassword) { alert('è¯·è¾“å…¥æ–°å¯†ç ï¼'); return; }
            if (newPassword.length < 4) { alert('å¯†ç è‡³å°‘4ä¸ªå­—ç¬¦ï¼'); return; }
            const student = students.find(s => s.code === studentCode);
            if (!student) { alert('å­¦ç”Ÿä¸å­˜åœ¨ï¼'); return; }
            const accounts = getStudentAccounts();
            accounts[studentCode] = newPassword;
            saveStudentAccounts(accounts);
            document.getElementById('reset-student').value = '';
            document.getElementById('new-password').value = '';
            alert(`å·²é‡ç½® ${student.name} çš„å¯†ç ä¸º: ${newPassword}`);
        }
        let batchAssignSelected = new Set();
        function showBatchAssignModal() {
            if (classes.length === 0) { alert('è¯·å…ˆåˆ›å»ºç­çº§ï¼'); return; }
            batchAssignSelected.clear();
            updateBatchAssignStudentList();
            updateClassSelects();
            document.getElementById('batch-assign-modal').classList.add('active');
        }
        function updateBatchAssignStudentList() {
            const list = document.getElementById('batch-assign-student-list');
            if (!list) return;
            list.innerHTML = '';
            if (students.length === 0) { list.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:#94A3B8;">æš‚æ— å­¦ç”Ÿ</td></tr>'; return; }
            students.forEach((s, i) => {
                const className = classes.find(c => c.code === s.classCode)?.name || 'æœªåˆ†é…';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input type="checkbox" onchange="toggleBatchAssign(${i},this.checked)"></td><td>${s.name}</td><td>${s.code}</td><td><span class="tag tag-success">${className}</span></td>`;
                list.appendChild(tr);
            });
        }
        function toggleBatchAssign(idx, checked) {
            if (checked) batchAssignSelected.add(idx);
            else batchAssignSelected.delete(idx);
        }
        function toggleBatchAssignAll(checked) {
            document.querySelectorAll('#batch-assign-student-list input[type="checkbox"]').forEach((cb, i) => {
                cb.checked = checked;
                if (checked) batchAssignSelected.add(i);
                else batchAssignSelected.delete(i);
            });
        }
        function doBatchAssign() {
            const classCode = document.getElementById('batch-assign-class').value;
            if (!classCode) { alert('è¯·é€‰æ‹©ç›®æ ‡ç­çº§ï¼'); return; }
            if (batchAssignSelected.size === 0) { alert('è¯·é€‰æ‹©è¦åˆ†é…çš„å­¦ç”Ÿï¼'); return; }
            const cls = classes.find(c => c.code === classCode);
            if (!cls) { alert('ç­çº§ä¸å­˜åœ¨ï¼'); return; }
            const indices = Array.from(batchAssignSelected);
            let count = 0;
            indices.forEach(idx => {
                if (students[idx]) {
                    students[idx].classCode = classCode;
                    count++;
                }
            });
            saveData();
            updateStudentList();
            updateClassList();
            updateClassSelects();
            hideModal('batch-assign-modal');
            alert(`æˆåŠŸå°† ${count} åå­¦ç”Ÿåˆ†é…åˆ° "${cls.name}"`);
        }
        function generateStudentId() {
            const year = new Date().getFullYear();
            const existingIds = students.map(s => s.code).filter(c => c && c.startsWith(year.toString()));
            let maxNum = 0;
            existingIds.forEach(id => { const num = parseInt(id.slice(4)); if (num > maxNum) maxNum = num; });
            return year.toString() + String(maxNum + 1).padStart(8, '0');
        }
        function addStudent() {
            const name = document.getElementById('student-name').value.trim();
            let code = document.getElementById('student-code').value.trim();
            const classCode = document.getElementById('student-class')?.value || '';
            if (!name) { alert('è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼'); return; }
            if (students.some(s => s.name === name)) { alert('å­¦ç”Ÿ "' + name + '" å·²å­˜åœ¨ï¼'); return; }
            if (code) {
                if (!code.match(/^\d{12}$/)) { alert('å­¦å·å¿…é¡»æ˜¯12ä½æ•°å­—ï¼'); return; }
                if (students.some(s => s.code === code)) { alert('å­¦å· "' + code + '" å·²å­˜åœ¨ï¼'); return; }
            } else { code = generateStudentId(); }
            students.push({name, code, classCode});
            saveData();
            updateAllTeacherViews();
            document.getElementById('student-name').value = '';
            document.getElementById('student-code').value = '';
        }
        function updateStudentList() {
            const list = document.getElementById('student-list');
            if (!list) return;
            list.innerHTML = '';
            selectedStudents.clear();
            if (students.length === 0) { list.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#94A3B8;">æš‚æ— å­¦ç”Ÿï¼Œè¯·æ·»åŠ </td></tr>'; return; }
            students.forEach((s, i) => {
                const className = classes.find(c => c.code === s.classCode)?.name || 'æœªåˆ†é…';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input type="checkbox" onchange="toggleSelect(${i},this.checked)"></td><td>${i+1}</td><td>${s.name}</td><td>${s.code}</td><td><span class="tag tag-success">${className}</span></td><td><button class="btn btn-danger btn-small" onclick="deleteStudent(${i})">åˆ é™¤</button></td>`;
                list.appendChild(tr);
            });
        }
        function toggleSelect(idx, checked) { if (checked) selectedStudents.add(idx); else selectedStudents.delete(idx); }
        function toggleAll(checked) { document.querySelectorAll('#student-list input[type="checkbox"]').forEach((cb, i) => { cb.checked = checked; if (checked) selectedStudents.add(i); else selectedStudents.delete(i); }); }
        function deleteStudent(idx) { if (confirm('ç¡®å®šåˆ é™¤ ' + students[idx].name + 'ï¼Ÿ')) { students.splice(idx, 1); saveData(); updateAllTeacherViews(); } }
        function deleteSelected() { if (selectedStudents.size === 0) { alert('è¯·å…ˆé€‰ä¸­è¦åˆ é™¤çš„å­¦ç”Ÿï¼'); return; } if (!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ' + selectedStudents.size + ' åå­¦ç”Ÿï¼Ÿ')) return; const toDelete = Array.from(selectedStudents).sort((a, b) => b - a); toDelete.forEach(idx => students.splice(idx, 1)); saveData(); updateAllTeacherViews(); }
        function clearAllStudents() { if (students.length === 0) return; if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿï¼Ÿ')) { students = []; saveData(); updateAllTeacherViews(); } }
        function showBatchImport() { document.getElementById('batch-modal').classList.add('active'); document.getElementById('batch-input').value = ''; }
        function doBatchImport() {
            const text = document.getElementById('batch-input').value.trim();
            if (!text) { alert('è¯·è¾“å…¥å­¦ç”Ÿä¿¡æ¯ï¼'); return; }
            let added = 0, skipped = 0;
            text.split('\n').forEach(line => {
                line = line.trim(); if (!line) return;
                let name, code;
                if (line.includes(',')) { const parts = line.split(','); name = parts[0].trim(); code = parts[1].trim(); if (code && !code.match(/^\d{12}$/)) code = null; }
                else { name = line; code = null; }
                if (!name || students.some(s => s.name === name)) { skipped++; return; }
                if (!code) code = generateStudentId();
                students.push({name, code}); added++;
            });
            saveData(); updateAllTeacherViews(); hideModal('batch-modal');
            alert('æˆåŠŸå¯¼å…¥ ' + added + ' åå­¦ç”Ÿ' + (skipped > 0 ? '\nè·³è¿‡ ' + skipped + ' ä¸ªé‡å¤é¡¹' : ''));
        }
        function randomRollCall() {
            const classCode = document.getElementById('roll-class')?.value || '';
            let filteredStudents = students;
            if (classCode) {
                filteredStudents = students.filter(s => s.classCode === classCode);
            }
            if (filteredStudents.length === 0) { alert(classCode ? 'è¯¥ç­çº§æš‚æ— å­¦ç”Ÿï¼' : 'åå•ä¸ºç©ºï¼'); return; }
            if (isAnimating) return;
            const num = Math.max(1, parseInt(document.getElementById('roll-num').value) || 1);
            if (num > filteredStudents.length) { alert('ç‚¹åäººæ•°è¶…è¿‡å­¦ç”Ÿæ€»æ•°ï¼'); return; }
            isAnimating = true;
            const targets = []; const temp = [...filteredStudents];
            for (let i = 0; i < num; i++) { const idx = Math.floor(Math.random() * temp.length); targets.push(temp.splice(idx, 1)[0]); }
            let step = 0; const totalSteps = 30; const resultEl = document.getElementById('roll-result');
            const animate = () => {
                step++;
                if (step < totalSteps) {
                    const sample = []; const temp2 = [...filteredStudents];
                    for (let i = 0; i < num; i++) { const idx = Math.floor(Math.random() * temp2.length); sample.push(temp2.splice(idx, 1)[0]); }
                    resultEl.textContent = sample.map(s => s.name).join('ã€');
                    resultEl.style.color = '#667eea';
                    setTimeout(animate, 30 + step * 10);
                } else {
                    resultEl.textContent = targets.map(s => s.name).join('ã€');
                    resultEl.style.color = '#DC2626';
                    const className = classCode ? (classes.find(c => c.code === classCode)?.name || '') : '';
                    document.getElementById('roll-info').textContent = `éšæœºç‚¹åå®Œæˆ (å…± ${num} äºº)${className ? ' - ' + className : ''}`;
                    isAnimating = false;
                    speakText(`${targets.map(s => s.name).join('ã€')}åŒå­¦ï¼Œè¯·å›ç­”é—®é¢˜`);
                }
            };
            animate();
        }
        function initAttendance() { 
            const today = new Date().toISOString().split('T')[0]; 
            attendedStudents = [...(attendanceRecords[today] || [])]; 
            updateAttendanceStats(); 
            updateAttendedList(); 
            // è‡ªåŠ¨åŒæ­¥å­¦ç”Ÿç«¯çš„ç­¾åˆ°è®°å½•
            syncAttendanceRecords();
        }
        function updateAttendanceStats() {
            const stats = document.getElementById('attendance-stats');
            if (!stats) return;
            const attended = attendedStudents.length;
            stats.innerHTML = `<div class="stat-card"><div class="stat-num" style="color:#10B981;">${attended}</div><div class="stat-label">å·²ç­¾åˆ°</div></div><div class="stat-card"><div class="stat-num" style="color:#EF4444;">${students.length - attended}</div><div class="stat-label">æœªç­¾åˆ°</div></div><div class="stat-card"><div class="stat-num" style="color:#475569;">${students.length}</div><div class="stat-label">æ€»äººæ•°</div></div>`;
        }
        function updateAttendedList() {
            const list = document.getElementById('attended-list');
            if (!list) return;
            list.innerHTML = '';
            if (attendedStudents.length === 0) { list.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:#94A3B8;">æš‚æ— ç­¾åˆ°è®°å½•</td></tr>'; return; }
            attendedStudents.forEach((s, i) => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${s.name}</td><td>${s.code}</td><td>${s.time || '-'}</td>`; list.appendChild(tr); });
        }
        function checkCode() {
            const codeInput = document.getElementById('attendance-code').value.trim();
            if (!codeInput) { alert('è¯·è¾“å…¥å­¦å·ï¼'); return; }
            const codes = codeInput.split(',').map(c => c.trim()).filter(c => c);
            let successCount = 0; const now = new Date().toLocaleTimeString();
            codes.forEach(code => {
                if (!code.match(/^\d{12}$/)) return;
                const student = students.find(s => s.code === code);
                if (!student || attendedStudents.some(s => s.code === code)) return;
                attendedStudents.push({...student, time: now}); successCount++;
            });
            if (successCount > 0) { alert('æˆåŠŸç­¾åˆ° ' + successCount + ' åå­¦ç”Ÿï¼'); updateAttendanceStats(); updateAttendedList(); }
            document.getElementById('attendance-code').value = '';
        }
        function finishAttendance() {
            if (attendedStudents.length === 0) { alert('æš‚æ— å­¦ç”Ÿç­¾åˆ°ï¼'); return; }
            const today = new Date().toISOString().split('T')[0];
            attendanceRecords[today] = [...attendedStudents];
            saveData();
            alert('ç­¾åˆ°å®Œæˆï¼\næ—¥æœŸ: ' + today + '\nç­¾åˆ°äººæ•°: ' + attendedStudents.length + ' äºº');
            updateHistoryList();
        }
        function updateHistoryList() {
            const list = document.getElementById('history-list');
            if (!list) return;
            list.innerHTML = '';
            const dates = Object.keys(attendanceRecords).sort().reverse();
            if (dates.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“…</div>æš‚æ— ç­¾åˆ°è®°å½•</div>'; return; }
            dates.forEach(date => {
                const records = attendanceRecords[date];
                const item = document.createElement('div');
                item.className = 'homework-item';
                item.style.borderLeftColor = '#667eea';
                item.innerHTML = `<div class="homework-title">ğŸ“… ${date}</div><div class="homework-info">ç­¾åˆ°äººæ•°: ${records.length} äºº</div><div class="homework-content">å­¦ç”Ÿ: ${records.map(s => s.name).join('ã€')}</div>`;
                list.appendChild(item);
            });
        }
        function showAddHomework() { document.getElementById('homework-modal').classList.add('active'); document.getElementById('homework-title').value = ''; document.getElementById('homework-content').value = ''; document.getElementById('homework-deadline').value = ''; }
        function saveHomework() {
            const title = document.getElementById('homework-title').value.trim();
            const content = document.getElementById('homework-content').value.trim();
            const deadline = document.getElementById('homework-deadline').value;
            if (!title || !content) { alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼'); return; }
            homeworks.unshift({id: Date.now(), title, content, deadline, createTime: new Date().toLocaleString()});
            saveData(); updateHomeworkList(); hideModal('homework-modal'); alert('ä½œä¸šå‘å¸ƒæˆåŠŸï¼');
        }
        function updateHomeworkList() {
            const list = document.getElementById('homework-list');
            if (!list) return;
            if (homeworks.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“š</div>æš‚æ— ä½œä¸š</div>'; return; }
            list.innerHTML = homeworks.map(hw => `<div class="homework-item"><div class="homework-title">${hw.title}</div><div class="homework-info">å‘å¸ƒæ—¶é—´: ${hw.createTime} ${hw.deadline ? '| æˆªæ­¢: ' + hw.deadline : ''}</div><div class="homework-content">${hw.content}</div><div style="margin-top:15px;"><button class="btn btn-danger btn-small" onclick="deleteHomework(${hw.id})">åˆ é™¤</button></div></div>`).join('');
        }
        function deleteHomework(id) { if (confirm('ç¡®å®šåˆ é™¤è¯¥ä½œä¸šï¼Ÿ')) { homeworks = homeworks.filter(h => h.id !== id); saveData(); updateHomeworkList(); } }
        function updateMessageTargets() {
            const select = document.getElementById('message-target');
            if (!select) return;
            select.innerHTML = '<option value="all">å…¨ä½“å­¦ç”Ÿ</option>';
            students.forEach(s => { select.innerHTML += `<option value="${s.code}">${s.name}</option>`; });
        }
        function showSendMessage() { document.getElementById('message-modal').classList.add('active'); document.getElementById('message-content').value = ''; updateMessageTargets(); }
        function sendMessage() {
            const target = document.getElementById('message-target').value;
            const content = document.getElementById('message-content').value.trim();
            if (!content) { alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼'); return; }
            const targetName = target === 'all' ? 'å…¨ä½“å­¦ç”Ÿ' : (students.find(s => s.code === target)?.name || 'æœªçŸ¥');
            messages.unshift({id: Date.now(), target, targetName, content, time: new Date().toLocaleString()});
            saveData(); updateMessageList(); hideModal('message-modal'); alert('æ¶ˆæ¯å‘é€æˆåŠŸï¼');
        }
        function updateMessageList() {
            const list = document.getElementById('message-list');
            if (!list) return;
            if (messages.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’¬</div>æš‚æ— æ¶ˆæ¯</div>'; return; }
            list.innerHTML = messages.map(msg => `<div class="message-item"><div class="message-header"><span class="message-from">å‘é€ç»™: ${msg.targetName}</span><span class="message-time">${msg.time}</span></div><div class="message-content">${msg.content}</div><div style="margin-top:15px;"><button class="btn btn-danger btn-small" onclick="deleteMessage(${msg.id})">åˆ é™¤</button></div></div>`).join('');
        }
        function deleteMessage(id) { if (confirm('ç¡®å®šåˆ é™¤è¯¥æ¶ˆæ¯ï¼Ÿ')) { messages = messages.filter(m => m.id !== id); saveData(); updateMessageList(); } }
        function addFriend() {
            const name = document.getElementById('friend-name').value.trim();
            const account = document.getElementById('friend-account').value.trim();
            if (!name || !account) { alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼'); return; }
            if (friends.some(f => f.account === account)) { alert('è¯¥å¥½å‹å·²å­˜åœ¨ï¼'); return; }
            friends.push({id: Date.now(), name, account, addTime: new Date().toLocaleString()});
            saveData(); updateFriendList();
            document.getElementById('friend-name').value = '';
            document.getElementById('friend-account').value = '';
            alert('å¥½å‹æ·»åŠ æˆåŠŸï¼');
        }
        function updateFriendList() {
            const list = document.getElementById('friend-list');
            if (!list) return;
            if (friends.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¤</div>æš‚æ— å¥½å‹</div>'; return; }
            list.innerHTML = friends.map(f => `<div class="friend-item"><div class="friend-info"><div class="friend-avatar">${f.name.charAt(0)}</div><div><div class="friend-name">${f.name}</div><div class="friend-status">è´¦å·: ${f.account} | æ·»åŠ äº ${f.addTime}</div></div></div><button class="btn btn-danger btn-small" onclick="deleteFriend(${f.id})">åˆ é™¤</button></div>`).join('');
        }
        function deleteFriend(id) { if (confirm('ç¡®å®šåˆ é™¤è¯¥å¥½å‹ï¼Ÿ')) { friends = friends.filter(f => f.id !== id); saveData(); updateFriendList(); } }
        function updateScoreStudentList() {
            const list = document.getElementById('score-student-list');
            if (!list) return;
            list.innerHTML = '';
            if (students.length === 0) { list.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#94A3B8;">æš‚æ— å­¦ç”Ÿï¼Œè¯·å…ˆæ·»åŠ </td></tr>'; return; }
            students.forEach((s, i) => {
                const studentScores = scores.filter(sc => sc.studentCode === s.code);
                const avgScore = studentScores.length > 0 ? (studentScores.map(sc => sc.score).reduce((a, b) => a + b, 0) / studentScores.length).toFixed(1) : '-';
                const avgColor = studentScores.length > 0 ? (avgScore >= 90 ? '#10B981' : (avgScore >= 60 ? '#F59E0B' : '#EF4444')) : '#64748b';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i+1}</td><td style="color:#667eea;font-weight:bold;">${s.name}</td><td>${s.code}</td><td style="color:${avgColor};font-weight:bold;">${avgScore}</td><td>${studentScores.length}</td><td><button class="btn btn-primary btn-small" onclick="openScoreModal('${s.code}','${s.name}')">æ‰“åˆ†</button></td>`;
                list.appendChild(tr);
            });
        }
        function openScoreModal(code, name) {
            currentScoreStudent = code;
            document.getElementById('score-modal-name').textContent = name;
            document.getElementById('score-type').value = 'å¹³æ—¶æˆç»©';
            document.getElementById('score-value').value = '';
            document.getElementById('score-remark').value = '';
            document.getElementById('score-modal').classList.add('active');
        }
        function submitScore() {
            if (!currentScoreStudent) { alert('è¯·é€‰æ‹©å­¦ç”Ÿï¼'); return; }
            const scoreType = document.getElementById('score-type').value;
            const scoreValue = parseInt(document.getElementById('score-value').value);
            const remark = document.getElementById('score-remark').value.trim();
            if (isNaN(scoreValue) || scoreValue < 0 || scoreValue > 100) { alert('è¯·è¾“å…¥æœ‰æ•ˆåˆ†æ•°ï¼ˆ0-100ï¼‰ï¼'); return; }
            const student = students.find(s => s.code === currentScoreStudent);
            if (!student) { alert('å­¦ç”Ÿä¸å­˜åœ¨ï¼'); return; }
            scores.unshift({id: Date.now(), studentCode: currentScoreStudent, studentName: student.name, scoreType, score: scoreValue, remark, time: new Date().toLocaleString()});
            saveData(); updateScoreStudentList(); updateScoreList(); updateScoreStats(); hideModal('score-modal'); alert('æ‰“åˆ†æˆåŠŸï¼');
        }
        function updateScoreList() {
            const list = document.getElementById('score-list');
            if (!list) return;
            list.innerHTML = '';
            const recentScores = scores.slice(0, 20);
            if (recentScores.length === 0) { list.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#94A3B8;">æš‚æ— æ‰“åˆ†è®°å½•</td></tr>'; return; }
            recentScores.forEach((s, i) => {
                const tr = document.createElement('tr');
                const scoreColor = s.score >= 90 ? '#10B981' : (s.score >= 60 ? '#F59E0B' : '#EF4444');
                tr.innerHTML = `<td>${i+1}</td><td>${s.studentName}</td><td>${s.studentCode}</td><td>${s.scoreType}</td><td style="color:${scoreColor};font-weight:bold;">${s.score}</td><td>${s.remark || '-'}</td><td>${s.time}</td><td><button class="btn btn-danger btn-small" onclick="deleteScore(${s.id})">åˆ é™¤</button></td>`;
                list.appendChild(tr);
            });
        }
        function deleteScore(id) { if (confirm('ç¡®å®šåˆ é™¤è¯¥æ‰“åˆ†è®°å½•ï¼Ÿ')) { scores = scores.filter(s => s.id !== id); saveData(); updateScoreList(); updateScoreStats(); } }
        function updateScoreStats() {
            const stats = document.getElementById('score-stats');
            const select = document.getElementById('stats-student');
            if (!stats) return;
            if (select) { select.innerHTML = '<option value="">é€‰æ‹©å­¦ç”ŸæŸ¥çœ‹è¯¦æƒ…</option>'; students.forEach(s => { select.innerHTML += `<option value="${s.code}">${s.name}</option>`; }); }
            if (students.length === 0 || scores.length === 0) {
                stats.innerHTML = `<div class="stat-card"><div class="stat-num">0</div><div class="stat-label">æ‰“åˆ†è®°å½•</div></div><div class="stat-card"><div class="stat-num">-</div><div class="stat-label">å¹³å‡åˆ†</div></div><div class="stat-card"><div class="stat-num">-</div><div class="stat-label">æœ€é«˜åˆ†</div></div><div class="stat-card"><div class="stat-num">-</div><div class="stat-label">æœ€ä½åˆ†</div></div>`;
                return;
            }
            const totalScores = scores.map(s => s.score);
            const avg = (totalScores.reduce((a, b) => a + b, 0) / totalScores.length).toFixed(1);
            stats.innerHTML = `<div class="stat-card"><div class="stat-num">${scores.length}</div><div class="stat-label">æ‰“åˆ†è®°å½•</div></div><div class="stat-card"><div class="stat-num" style="color:#667eea;">${avg}</div><div class="stat-label">å¹³å‡åˆ†</div></div><div class="stat-card"><div class="stat-num" style="color:#10B981;">${Math.max(...totalScores)}</div><div class="stat-label">æœ€é«˜åˆ†</div></div><div class="stat-card"><div class="stat-num" style="color:#EF4444;">${Math.min(...totalScores)}</div><div class="stat-label">æœ€ä½åˆ†</div></div>`;
        }
        function showStudentScoreDetail() {
            const studentCode = document.getElementById('stats-student').value;
            const detail = document.getElementById('score-detail');
            if (!studentCode) { detail.innerHTML = ''; return; }
            const studentScores = scores.filter(s => s.studentCode === studentCode);
            const student = students.find(s => s.code === studentCode);
            if (studentScores.length === 0) { detail.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div>${student.name} æš‚æ— æ‰“åˆ†è®°å½•</div>`; return; }
            const avg = (studentScores.map(s => s.score).reduce((a, b) => a + b, 0) / studentScores.length).toFixed(1);
            let html = `<div class="homework-item" style="margin-top:20px;"><div class="homework-title">${student.name} çš„æˆç»©è¯¦æƒ…</div><div class="homework-info">å…± ${studentScores.length} æ¡è®°å½• | å¹³å‡åˆ†: <strong style="color:#667eea;">${avg}</strong></div><div style="margin-top:15px;">`;
            const typeScores = {};
            studentScores.forEach(s => { if (!typeScores[s.scoreType]) typeScores[s.scoreType] = []; typeScores[s.scoreType].push(s.score); });
            for (const type in typeScores) { const typeAvg = (typeScores[type].reduce((a, b) => a + b, 0) / typeScores[type].length).toFixed(1); html += `<span class="tag tag-success" style="margin-right:8px;margin-bottom:8px;">${type}: ${typeScores[type].join('/')} (å‡${typeAvg})</span>`; }
            html += '</div></div>'; detail.innerHTML = html;
        }
        function exportScores() {
            if (scores.length === 0) { alert('æš‚æ— æˆç»©æ•°æ®å¯å¯¼å‡ºï¼'); return; }
            let csv = '\uFEFFåºå·,å§“å,å­¦å·,è¯„åˆ†ç±»å‹,åˆ†æ•°,å¤‡æ³¨,æ—¶é—´\n';
            scores.forEach((s, i) => { csv += `${i+1},${s.studentName},${s.studentCode},${s.scoreType},${s.score},${s.remark || ''},${s.time}\n`; });
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'å­¦ç”Ÿæˆç»©_' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
            alert('æˆç»©å·²å¯¼å‡ºï¼');
        }
        function updateCallStudentSelect() {
            const select = document.getElementById('call-student');
            if (!select) return;
            select.innerHTML = '<option value="">é€‰æ‹©å­¦ç”Ÿæ‰‹åŠ¨å‘¼å«</option>';
            students.forEach(s => { select.innerHTML += `<option value="${s.code}">${s.name}</option>`; });
        }
        function randomCallStudent() {
            if (students.length === 0) { alert('æš‚æ— å­¦ç”Ÿï¼'); return; }
            const availableStudents = students.filter(s => !callQueue.some(q => q.code === s.code));
            if (availableStudents.length === 0) { alert('æ‰€æœ‰å­¦ç”Ÿéƒ½åœ¨æ’é˜Ÿä¸­ï¼'); return; }
            const randomIndex = Math.floor(Math.random() * availableStudents.length);
            addToCallQueue(availableStudents[randomIndex]);
        }
        function callSelectedStudent() {
            const code = document.getElementById('call-student').value;
            if (!code) { alert('è¯·é€‰æ‹©å­¦ç”Ÿï¼'); return; }
            if (callQueue.some(q => q.code === code)) { alert('è¯¥å­¦ç”Ÿå·²åœ¨æ’é˜Ÿä¸­ï¼'); return; }
            const student = students.find(s => s.code === code);
            if (student) { addToCallQueue(student); document.getElementById('call-student').value = ''; }
        }
        function addToCallQueue(student) {
            const now = new Date();
            const task = document.getElementById('call-task').value.trim() || 'æ¥åŠå…¬å®¤ä¸€è¶Ÿ';
            const callItem = {id: Date.now(), code: student.code, name: student.name, task, callTime: now.toLocaleString(), status: 'waiting'};
            callQueue.push(callItem);
            callRecords.unshift(callItem);
            saveData(); updateCallQueueList(); updateCallHistoryList(); updateCallStats();
            document.getElementById('call-result').textContent = student.name;
            document.getElementById('call-result').style.color = '#DC2626';
            document.getElementById('call-info').innerHTML = `<span style="font-size:16px;">è¯· <strong style="color:#DC2626;">${student.name}</strong> åˆ°åŠå…¬å®¤ï¼</span><br><span style="font-size:14px;color:#64748b;">å­¦å·ï¼š${student.code} | å‘¼å«æ—¶é—´ï¼š${now.toLocaleTimeString()}</span>`;
            document.getElementById('call-task-display').innerHTML = `ä»»åŠ¡ï¼š${task} <button class="btn btn-success btn-small" style="margin-left:15px;" onclick="confirmStudentArrived(${callItem.id})">âœ“ å·²åˆ°è¾¾</button>`;
            speakCallStudent(student.name, task);
        }
        function callNextInQueue() {
            if (callQueue.length === 0) { alert('æ’é˜ŸåŒºæ²¡æœ‰å­¦ç”Ÿï¼'); return; }
            const next = callQueue[0];
            document.getElementById('call-result').textContent = next.name;
            document.getElementById('call-result').style.color = '#DC2626';
            document.getElementById('call-info').innerHTML = `<span style="font-size:16px;">è¯· <strong style="color:#DC2626;">${next.name}</strong> åˆ°åŠå…¬å®¤ï¼</span><br><span style="font-size:14px;color:#64748b;">å­¦å·ï¼š${next.code}</span>`;
            document.getElementById('call-task-display').innerHTML = `ä»»åŠ¡ï¼š${next.task || 'æ¥åŠå…¬å®¤ä¸€è¶Ÿ'} <button class="btn btn-success btn-small" style="margin-left:15px;" onclick="confirmStudentArrived(${next.id})">âœ“ å·²åˆ°è¾¾</button>`;
            speakCallStudent(next.name, next.task || 'æ¥åŠå…¬å®¤ä¸€è¶Ÿ');
        }
        function confirmStudentArrived(id) { studentArrived(id); document.getElementById('call-result').textContent = 'ç‚¹å‡»å«å·'; document.getElementById('call-result').style.color = '#667eea'; document.getElementById('call-info').textContent = ''; document.getElementById('call-task-display').textContent = ''; }
        function studentArrived(id) {
            const index = callQueue.findIndex(q => q.id === id);
            if (index !== -1) {
                const item = callQueue[index];
                item.status = 'arrived'; item.arriveTime = new Date().toLocaleString();
                const recordIndex = callRecords.findIndex(r => r.id === id);
                if (recordIndex !== -1) callRecords[recordIndex] = item;
                callQueue.splice(index, 1);
                saveData(); updateCallQueueList(); updateCallHistoryList(); updateCallStats();
            }
        }
        function removeFromQueue(id) {
            const index = callQueue.findIndex(q => q.id === id);
            if (index !== -1) {
                const item = callQueue[index]; item.status = 'cancelled';
                const recordIndex = callRecords.findIndex(r => r.id === id);
                if (recordIndex !== -1) callRecords[recordIndex] = item;
                callQueue.splice(index, 1);
                saveData(); updateCallQueueList(); updateCallHistoryList(); updateCallStats();
            }
        }
        function speakCallStudent(name, task) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode); gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800; oscillator.type = 'sine'; gainNode.gain.value = 0.3;
                oscillator.start(); oscillator.stop(audioContext.currentTime + 0.3);
                setTimeout(() => { const osc2 = audioContext.createOscillator(); osc2.connect(gainNode); osc2.frequency.value = 1000; osc2.type = 'sine'; osc2.start(); osc2.stop(audioContext.currentTime + 0.3); }, 350);
            } catch(e) {}
            setTimeout(() => speakText(`è¯·${name}åŒå­¦ï¼Œ${task}`), 800);
        }
        function updateCallQueueList() {
            const list = document.getElementById('call-queue-list');
            if (!list) return;
            list.innerHTML = '';
            if (callQueue.length === 0) { list.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#94A3B8;">æ’é˜ŸåŒºæš‚æ— å­¦ç”Ÿ</td></tr>'; return; }
            callQueue.forEach((item, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i+1}</td><td style="color:#667eea;font-weight:bold;">${item.name}</td><td>${item.code}</td><td>${item.task || 'æ¥åŠå…¬å®¤ä¸€è¶Ÿ'}</td><td>${item.callTime}</td><td><button class="btn btn-success btn-small" onclick="studentArrived(${item.id})">å·²åˆ°è¾¾</button> <button class="btn btn-danger btn-small" onclick="removeFromQueue(${item.id})">å–æ¶ˆ</button></td>`;
                list.appendChild(tr);
            });
        }
        function updateCallHistoryList() {
            const list = document.getElementById('call-history-list');
            if (!list) return;
            list.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = callRecords.filter(r => r.callTime && r.callTime.includes(today));
            if (todayRecords.length === 0) { list.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#94A3B8;">ä»Šæ—¥æš‚æ— å«å·è®°å½•</td></tr>'; return; }
            todayRecords.slice(0, 20).forEach((item, i) => {
                const tr = document.createElement('tr');
                let statusTag = item.status === 'arrived' ? '<span class="tag tag-success">å·²åˆ°è¾¾</span>' : (item.status === 'waiting' ? '<span class="tag tag-warning">ç­‰å¾…ä¸­</span>' : '<span class="tag tag-danger">å·²å–æ¶ˆ</span>');
                tr.innerHTML = `<td>${i+1}</td><td>${item.name}</td><td>${item.code}</td><td>${item.task || 'æ¥åŠå…¬å®¤ä¸€è¶Ÿ'}</td><td>${item.callTime}</td><td>${statusTag}</td>`;
                list.appendChild(tr);
            });
        }
        function updateCallStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = callRecords.filter(r => r.callTime && r.callTime.includes(today));
            const total = document.getElementById('call-total');
            const arrived = document.getElementById('call-arrived');
            const waiting = document.getElementById('call-waiting');
            if (total) total.textContent = todayRecords.length;
            if (arrived) arrived.textContent = todayRecords.filter(r => r.status === 'arrived').length;
            if (waiting) waiting.textContent = callQueue.length;
        }
        function updateDataStats() {
            const ds = document.getElementById('data-students');
            const dr = document.getElementById('data-records');
            if (ds) ds.textContent = students.length;
            if (dr) dr.textContent = Object.keys(attendanceRecords).length;
        }
        function exportData() {
            if (students.length === 0 && homeworks.length === 0 && messages.length === 0) { alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼'); return; }
            const data = {students, attendance: attendanceRecords, homeworks, messages, friends, scores, callQueue, callRecords, exportDate: new Date().toISOString()};
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ç­çº§é€šæ•°æ®_' + new Date().toISOString().split('T')[0] + '.json'; a.click();
            alert('æ•°æ®å·²å¯¼å‡ºï¼');
        }
        function importData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.students) {
                        students = data.students; attendanceRecords = data.attendance || {}; homeworks = data.homeworks || []; messages = data.messages || []; friends = data.friends || []; scores = data.scores || []; callQueue = data.callQueue || []; callRecords = data.callRecords || [];
                        saveData(); updateAllTeacherViews();
                        alert('å¯¼å…¥æˆåŠŸï¼å…± ' + students.length + ' åå­¦ç”Ÿ');
                    } else { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼'); }
                } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // Student functions
        function showStudentScreen(screen) {
            document.querySelectorAll('#student-main .sidebar-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.sidebar-btn').classList.add('active');
            renderStudentScreen(screen);
            if (screen === 'call') document.getElementById('call-badge').classList.remove('active');
            if (screen === 'chat') updateFriendRequests();
        }
        function renderStudentScreen(screen) {
            const content = document.getElementById('student-content');
            const screens = {
                home: `<div class="card"><div class="card-title">ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ç­çº§é€š</div><div class="stats-grid" id="home-stats"></div></div><div class="card"><div class="card-title">ğŸ“¢ æœ€æ–°é€šçŸ¥</div><div id="home-notifications"></div></div>`,
                myclass: `<div class="card"><div class="card-title">ğŸ« æˆ‘çš„ç­çº§</div><div id="my-class-info"></div></div><div class="card"><div class="card-title">ğŸ”— åŠ å…¥ç­çº§</div><p class="tip-text">è¾“å…¥ç­çº§ä»£ç ç”³è¯·åŠ å…¥ç­çº§</p><div class="form-row"><input type="text" id="join-class-code" placeholder="è¯·è¾“å…¥ç­çº§ä»£ç " style="flex:1;"><button class="btn btn-primary" onclick="joinClass()">ç”³è¯·åŠ å…¥</button></div><div id="available-classes"></div></div><div class="card"><div class="card-title">ğŸ‘¥ ç­çº§æˆå‘˜</div><div id="class-members"></div></div>`,
                call: `<div class="card"><div class="card-title">ğŸ“¢ å«å·é€šçŸ¥</div><div class="call-alert" id="student-call-alert"><div class="call-alert-title">ğŸ”” æ‚¨è¢«è€å¸ˆå‘¼å«äº†ï¼</div><div class="call-alert-content" id="student-call-content"></div></div><div id="student-call-history"></div></div>`,
                homework: `<div class="card"><div class="card-title">ğŸ“š æˆ‘çš„ä½œä¸š</div><div id="student-homework-list"></div></div>`,
                score: `<div class="card"><div class="card-title">â­ æˆ‘çš„æˆç»©</div><div class="stats-grid" id="student-score-stats"></div><div id="student-score-list"></div></div>`,
                attendance: `<div class="card"><div class="card-title">âœ… ç­¾åˆ°</div><div class="form-row"><input type="text" id="student-attendance-code" placeholder="è¯·è¾“å…¥å­¦å·" style="flex:1;"><input type="text" id="student-attendance-check-code" placeholder="è¯·è¾“å…¥ç­¾åˆ°ç " style="flex:0.5;"><button class="btn btn-success" onclick="doStudentAttendance()">ç­¾åˆ°</button></div><div id="student-attendance-status"></div></div><div class="card"><div class="card-title">ğŸ“‹ æˆ‘çš„ç­¾åˆ°è®°å½•</div><div id="student-attendance-history"></div></div>`,
                chat: `<div class="card"><div class="card-title">ğŸ’¬ èŠå¤©</div><div class="stats-grid"><div class="stat-card"><div class="stat-num" id="friend-count">0</div><div class="stat-label">å¥½å‹æ•°é‡</div></div><div class="stat-card"><div class="stat-num" style="color:#F59E0B;" id="pending-request-count">0</div><div class="stat-label">å¾…å¤„ç†ç”³è¯·</div></div></div></div><div class="card"><div class="card-title">ğŸ” æ·»åŠ å¥½å‹</div><div class="form-row"><input type="text" id="search-friend-code" placeholder="è¾“å…¥å­¦å·æœç´¢" style="flex:1;"><button class="btn btn-primary" onclick="searchStudentToAdd()">æœç´¢</button></div><div id="search-result"></div></div><div class="card"><div class="card-title">ğŸ“¥ å¥½å‹ç”³è¯·<span class="notification-badge" id="friend-request-badge">æ–°</span></div><div id="friend-requests-list"></div></div><div class="card"><div class="card-title">ğŸ“¢ ç³»ç»Ÿæ¶ˆæ¯</div><div id="student-message-list"></div></div><div class="card"><div class="card-title">ğŸ‘¥ å¥½å‹åˆ—è¡¨</div><div id="student-friend-list"></div></div>`
            };
            content.innerHTML = screens[screen] || '';
            updateStudentLists();
            if (screen === 'friend') updateFriendRequests();
        }
        function updateAllStudentViews() { renderStudentScreen('home'); updateStudentLists(); }
        function updateStudentLists() {
            updateHomeStats();
            updateHomeNotifications();
            updateMyClassInfo();
            updateAvailableClasses();
            updateClassMembers();
            updateStudentHomeworkList();
            updateStudentMessageList();
            updateStudentScoreList();
            updateStudentAttendanceHistory();
            updateStudentFriendList();
            updateStudentCallHistory();
        }
        function updateMyClassInfo() {
            const container = document.getElementById('my-class-info');
            if (!container || !currentStudent) return;
            const student = students.find(s => s.code === currentStudent.code);
            if (!student || !student.classCode) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ«</div>æ‚¨è¿˜æœªåŠ å…¥ä»»ä½•ç­çº§<br>è¯·åœ¨ä¸‹æ–¹è¾“å…¥ç­çº§ä»£ç ç”³è¯·åŠ å…¥</div>';
                return;
            }
            const cls = classes.find(c => c.code === student.classCode);
            if (!cls) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div>æ‚¨æ‰€åœ¨çš„ç­çº§å·²è¢«è§£æ•£<br>è¯·é‡æ–°åŠ å…¥å…¶ä»–ç­çº§</div>';
                return;
            }
            const memberCount = students.filter(s => s.classCode === cls.code).length;
            container.innerHTML = `<div class="homework-item" style="border-left-color:#667eea;"><div class="homework-title" style="font-size:24px;">${cls.name}</div><div class="homework-info">ç­çº§ä»£ç : <strong style="color:#667eea;">${cls.code}</strong> | æˆå‘˜äººæ•°: ${memberCount} äºº</div><div class="homework-info">åˆ›å»ºæ—¶é—´: ${cls.createTime}</div></div>`;
        }
        function updateAvailableClasses() {
            const container = document.getElementById('available-classes');
            if (!container || !currentStudent) return;
            if (classes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div>æš‚æ— å¯åŠ å…¥çš„ç­çº§</div>';
                return;
            }
            const student = students.find(s => s.code === currentStudent.code);
            const myClassCode = student?.classCode || '';
            let html = '<div style="margin-top:15px;"><p style="font-weight:bold;color:#475569;margin-bottom:10px;">å¯åŠ å…¥çš„ç­çº§åˆ—è¡¨ï¼š</p>';
            classes.forEach(c => {
                const memberCount = students.filter(s => s.classCode === c.code).length;
                const isMyClass = c.code === myClassCode;
                html += `<div class="friend-item"><div class="friend-info"><div class="friend-avatar" style="background:${isMyClass ? 'linear-gradient(135deg, #10B981 0%, #059669 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};">${c.name.charAt(0)}</div><div><div class="friend-name">${c.name}</div><div class="friend-status">ä»£ç : ${c.code} | ${memberCount} äºº</div></div></div>${isMyClass ? '<span class="tag tag-success">å·²åŠ å…¥</span>' : `<button class="btn btn-primary btn-small" onclick="joinClassByCode('${c.code}')">åŠ å…¥</button>`}</div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        function updateClassMembers() {
            const container = document.getElementById('class-members');
            if (!container || !currentStudent) return;
            const student = students.find(s => s.code === currentStudent.code);
            if (!student || !student.classCode) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div>åŠ å…¥ç­çº§åå¯æŸ¥çœ‹ç­çº§æˆå‘˜</div>';
                return;
            }
            const classStudents = students.filter(s => s.classCode === student.classCode);
            if (classStudents.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div>ç­çº§æš‚æ— æˆå‘˜</div>';
                return;
            }
            let html = '<div class="table-container"><table class="student-table"><thead><tr><th>åºå·</th><th>å§“å</th><th>å­¦å·</th></tr></thead><tbody>';
            classStudents.forEach((s, i) => {
                const isMe = s.code === currentStudent.code;
                html += `<tr><td>${i+1}</td><td style="color:${isMe ? '#667eea' : '#1E293B'};font-weight:${isMe ? 'bold' : 'normal'};">${s.name}${isMe ? ' (æˆ‘)' : ''}</td><td>${s.code}</td></tr>`;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        function joinClass() {
            const code = document.getElementById('join-class-code').value.trim();
            if (!code) { alert('è¯·è¾“å…¥ç­çº§ä»£ç ï¼'); return; }
            joinClassByCode(code);
        }
        function joinClassByCode(code) {
            if (!currentStudent) return;
            const cls = classes.find(c => c.code === code);
            if (!cls) { alert('ç­çº§ä»£ç ä¸å­˜åœ¨ï¼'); return; }
            const student = students.find(s => s.code === currentStudent.code);
            if (!student) { alert('å­¦ç”Ÿä¿¡æ¯ä¸å­˜åœ¨ï¼'); return; }
            if (student.classCode === code) { alert('æ‚¨å·²åœ¨è¯¥ç­çº§ä¸­ï¼'); return; }
            if (student.classCode) {
                const oldClass = classes.find(c => c.code === student.classCode);
                if (!confirm(`æ‚¨å½“å‰åœ¨ "${oldClass?.name || 'æœªçŸ¥ç­çº§'}"ï¼Œç¡®å®šè¦è½¬åˆ° "${cls.name}" å—ï¼Ÿ`)) return;
            }
            student.classCode = code;
            saveData();
            updateMyClassInfo();
            updateAvailableClasses();
            updateClassMembers();
            document.getElementById('join-class-code').value = '';
            alert(`æˆåŠŸåŠ å…¥ç­çº§: ${cls.name}`);
        }
        function updateHomeStats() {
            const stats = document.getElementById('home-stats');
            if (!stats || !currentStudent) return;
            const myScores = scores.filter(s => s.studentCode === currentStudent.code);
            const avgScore = myScores.length > 0 ? (myScores.map(s => s.score).reduce((a, b) => a + b, 0) / myScores.length).toFixed(1) : '-';
            const today = new Date().toISOString().split('T')[0];
            const myAttendance = attendanceRecords[today]?.some(s => s.code === currentStudent.code);
            const student = students.find(s => s.code === currentStudent.code);
            const className = student?.classCode ? (classes.find(c => c.code === student.classCode)?.name || 'æœªåˆ†é…') : 'æœªåŠ å…¥';
            stats.innerHTML = `<div class="stat-card"><div class="stat-num">${avgScore}</div><div class="stat-label">å¹³å‡æˆç»©</div></div><div class="stat-card"><div class="stat-num">${myScores.length}</div><div class="stat-label">æ‰“åˆ†æ¬¡æ•°</div></div><div class="stat-card"><div class="stat-num" style="color:${myAttendance ? '#10B981' : '#EF4444'};">${myAttendance ? 'å·²ç­¾åˆ°' : 'æœªç­¾åˆ°'}</div><div class="stat-label">ä»Šæ—¥çŠ¶æ€</div></div><div class="stat-card"><div class="stat-num" style="font-size:20px;">${className}</div><div class="stat-label">æˆ‘çš„ç­çº§</div></div>`;
        }
        function updateHomeNotifications() {
            const container = document.getElementById('home-notifications');
            if (!container || !currentStudent) return;
            let html = '';
            const myCalls = callRecords.filter(c => c.code === currentStudent.code && c.status === 'waiting');
            if (myCalls.length > 0) { html += `<div class="call-alert active"><div class="call-alert-title">ğŸ”” æ‚¨è¢«è€å¸ˆå‘¼å«äº†ï¼</div><div class="call-alert-content">ä»»åŠ¡ï¼š${myCalls[0].task || 'æ¥åŠå…¬å®¤ä¸€è¶Ÿ'}</div></div>`; }
            const myFriendRequests = friendRequests.filter(r => r.to === currentStudent.code && r.status === 'pending');
            if (myFriendRequests.length > 0) {
                html += `<div class="call-alert active" style="background:linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);border-left-color:#667eea;"><div class="call-alert-title" style="color:#4338CA;">ğŸ¤ æ–°çš„å¥½å‹ç”³è¯·</div><div class="call-alert-content" style="color:#4F46E5;">${myFriendRequests.map(r => r.fromName).join('ã€')} æƒ³æ·»åŠ æ‚¨ä¸ºå¥½å‹</div></div>`;
            }
            const recentMessages = messages.filter(m => m.target === 'all' || m.target === currentStudent.code).slice(0, 2);
            recentMessages.forEach(msg => { html += `<div class="message-item"><div class="message-header"><span class="message-from">ğŸ“¢ è€å¸ˆæ¶ˆæ¯</span><span class="message-time">${msg.time}</span></div><div class="message-content">${msg.content}</div></div>`; });
            if (!html) html = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div>æš‚æ— æ–°é€šçŸ¥</div>';
            container.innerHTML = html;
        }
        function updateStudentHomeworkList() {
            const list = document.getElementById('student-homework-list');
            if (!list) return;
            if (homeworks.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“š</div>æš‚æ— ä½œä¸š</div>'; return; }
            list.innerHTML = homeworks.map(hw => `<div class="homework-item"><div class="homework-title">${hw.title}</div><div class="homework-info">å‘å¸ƒæ—¶é—´: ${hw.createTime} ${hw.deadline ? '| æˆªæ­¢: ' + hw.deadline : ''}</div><div class="homework-content">${hw.content}</div></div>`).join('');
        }
        function updateStudentMessageList() {
            const list = document.getElementById('student-message-list');
            if (!list || !currentStudent) return;
            const myMessages = messages.filter(m => m.target === 'all' || m.target === currentStudent.code);
            if (myMessages.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’¬</div>æš‚æ— æ¶ˆæ¯</div>'; return; }
            list.innerHTML = myMessages.map(msg => `<div class="message-item"><div class="message-header"><span class="message-from">ğŸ“¢ ${msg.targetName}</span><span class="message-time">${msg.time}</span></div><div class="message-content">${msg.content}</div></div>`).join('');
        }
        function updateStudentScoreList() {
            const list = document.getElementById('student-score-list');
            const stats = document.getElementById('student-score-stats');
            if (!list || !currentStudent) return;
            const myScores = scores.filter(s => s.studentCode === currentStudent.code);
            if (myScores.length === 0) {
                if (stats) stats.innerHTML = `<div class="stat-card"><div class="stat-num">-</div><div class="stat-label">å¹³å‡åˆ†</div></div><div class="stat-card"><div class="stat-num">0</div><div class="stat-label">æ‰“åˆ†æ¬¡æ•°</div></div>`;
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â­</div>æš‚æ— æˆç»©è®°å½•</div>'; return;
            }
            const avg = (myScores.map(s => s.score).reduce((a, b) => a + b, 0) / myScores.length).toFixed(1);
            if (stats) stats.innerHTML = `<div class="stat-card"><div class="stat-num" style="color:#667eea;">${avg}</div><div class="stat-label">å¹³å‡åˆ†</div></div><div class="stat-card"><div class="stat-num" style="color:#10B981;">${Math.max(...myScores.map(s => s.score))}</div><div class="stat-label">æœ€é«˜åˆ†</div></div><div class="stat-card"><div class="stat-num" style="color:#EF4444;">${Math.min(...myScores.map(s => s.score))}</div><div class="stat-label">æœ€ä½åˆ†</div></div><div class="stat-card"><div class="stat-num">${myScores.length}</div><div class="stat-label">æ‰“åˆ†æ¬¡æ•°</div></div>`;
            list.innerHTML = myScores.map(s => {
                const scoreClass = s.score >= 90 ? 'score-high' : (s.score >= 60 ? 'score-mid' : 'score-low');
                return `<div class="score-item"><div class="score-info"><span class="score-type">${s.scoreType}</span><span class="score-time">${s.time} ${s.remark ? '| ' + s.remark : ''}</span></div><span class="score-value ${scoreClass}">${s.score}</span></div>`;
            }).join('');
        }
        function setAttendanceCode() {
            const code = document.getElementById('attendance-check-code').value.trim();
            if (!code) {
                alert('è¯·è¾“å…¥ç­¾åˆ°ç ï¼');
                return;
            }
            if (!/^\d{6}$/.test(code)) {
                alert('ç­¾åˆ°ç å¿…é¡»æ˜¯6ä½æ•°å­—ï¼');
                return;
            }
            currentAttendanceCode = code;
            alert('ç­¾åˆ°ç è®¾ç½®æˆåŠŸï¼š' + code);
        }
        
        function doStudentAttendance() {
            const code = document.getElementById('student-attendance-code').value.trim();
            const checkCode = document.getElementById('student-attendance-check-code').value.trim();
            if (!code) { alert('è¯·è¾“å…¥å­¦å·ï¼'); return; }
            if (!checkCode) { alert('è¯·è¾“å…¥ç­¾åˆ°ç ï¼'); return; }
            if (code !== currentStudent.code) { alert('è¯·è¾“å…¥æ‚¨è‡ªå·±çš„å­¦å·ï¼'); return; }
            if (!currentAttendanceCode) {
                alert('è€å¸ˆå°šæœªè®¾ç½®ç­¾åˆ°ç ï¼');
                return;
            }
            if (checkCode !== currentAttendanceCode) {
                alert('ç­¾åˆ°ç é”™è¯¯ï¼');
                return;
            }
            const today = new Date().toISOString().split('T')[0];
            if (!attendanceRecords[today]) attendanceRecords[today] = [];
            if (attendanceRecords[today].some(s => s.code === currentStudent.code)) {
                document.getElementById('student-attendance-status').innerHTML = '<div class="message-item" style="border-left-color:#F59E0B;"><div class="message-content">æ‚¨ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†ï¼</div></div>'; return;
            }
            attendanceRecords[today].push({code: currentStudent.code, name: currentStudent.name, time: new Date().toLocaleTimeString()});
            saveData();
            document.getElementById('student-attendance-code').value = '';
            document.getElementById('student-attendance-check-code').value = '';
            document.getElementById('student-attendance-status').innerHTML = '<div class="message-item" style="border-left-color:#10B981;"><div class="message-content">âœ… ç­¾åˆ°æˆåŠŸï¼æ—¶é—´ï¼š' + new Date().toLocaleTimeString() + '</div></div>';
            updateStudentAttendanceHistory(); updateHomeStats();
        }
        function updateStudentAttendanceHistory() {
            const container = document.getElementById('student-attendance-history');
            if (!container || !currentStudent) return;
            const dates = Object.keys(attendanceRecords).sort().reverse();
            if (dates.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div>æš‚æ— ç­¾åˆ°è®°å½•</div>'; return; }
            let html = '<div class="table-container"><table class="student-table"><thead><tr><th>æ—¥æœŸ</th><th>ç­¾åˆ°æ—¶é—´</th><th>çŠ¶æ€</th></tr></thead><tbody>';
            dates.slice(0, 10).forEach(date => {
                const record = attendanceRecords[date].find(s => s.code === currentStudent.code);
                html += `<tr><td>${date}</td><td>${record ? record.time : '-'}</td><td>${record ? '<span class="tag tag-success">å·²ç­¾åˆ°</span>' : '<span class="tag tag-danger">æœªç­¾åˆ°</span>'}</td></tr>`;
            });
            html += '</tbody></table></div>'; container.innerHTML = html;
        }
        function searchStudentToAdd() {
            const code = document.getElementById('search-friend-code').value.trim();
            const container = document.getElementById('search-result');
            if (!container) return;
            if (!code) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div>è¯·è¾“å…¥å­¦å·æœç´¢</div>'; return; }
            if (code === currentStudent.code) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ˜…</div>ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹</div>'; return; }
            const student = students.find(s => s.code === code);
            if (!student) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div>æœªæ‰¾åˆ°è¯¥å­¦å·çš„å­¦ç”Ÿ</div>'; return; }
            const myFriends = getMyFriends();
            const isFriend = myFriends.some(f => f.code === code);
            const pendingSent = friendRequests.some(r => r.from === currentStudent.code && r.to === code && r.status === 'pending');
            let btnHtml = '';
            if (isFriend) {
                btnHtml = '<span class="tag tag-success">å·²æ˜¯å¥½å‹</span>';
            } else if (pendingSent) {
                btnHtml = '<span class="tag tag-warning">å¾…éªŒè¯</span>';
            } else {
                btnHtml = `<button class="btn btn-primary btn-small" onclick="sendFriendRequest('${code}')">æ·»åŠ å¥½å‹</button>`;
            }
            const className = classes.find(c => c.code === student.classCode)?.name || 'æœªåˆ†é…';
            container.innerHTML = `<div class="friend-item"><div class="friend-info"><div class="friend-avatar">${student.name.charAt(0)}</div><div><div class="friend-name">${student.name}</div><div class="friend-status">å­¦å·: ${student.code} | ç­çº§: ${className}</div></div></div>${btnHtml}</div>`;
        }
        function sendFriendRequest(toCode) {
            if (!currentStudent) return;
            const existing = friendRequests.find(r => r.from === currentStudent.code && r.to === toCode && r.status === 'pending');
            if (existing) { alert('å·²å‘é€è¿‡ç”³è¯·ï¼Œè¯·ç­‰å¾…å¯¹æ–¹éªŒè¯ï¼'); return; }
            const toStudent = students.find(s => s.code === toCode);
            if (!toStudent) { alert('è¯¥å­¦ç”Ÿä¸å­˜åœ¨ï¼'); return; }
            friendRequests.push({
                id: Date.now(),
                from: currentStudent.code,
                fromName: currentStudent.name,
                to: toCode,
                toName: toStudent.name,
                status: 'pending',
                time: new Date().toLocaleString()
            });
            saveData();
            document.getElementById('search-friend-code').value = '';
            document.getElementById('search-result').innerHTML = '<div class="empty-state"><div class="empty-state-icon">âœ…</div>å¥½å‹ç”³è¯·å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹éªŒè¯</div>';
            alert('å¥½å‹ç”³è¯·å·²å‘é€ï¼');
        }
        function updateFriendRequests() {
            const container = document.getElementById('friend-requests-list');
            const countEl = document.getElementById('pending-request-count');
            const badge = document.getElementById('friend-request-badge');
            if (!currentStudent) return;
            const myRequests = friendRequests.filter(r => r.to === currentStudent.code && r.status === 'pending');
            if (countEl) countEl.textContent = myRequests.length;
            if (badge) { if (myRequests.length > 0) badge.classList.add('active'); else badge.classList.remove('active'); }
            if (!container) return;
            if (myRequests.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div>æš‚æ— å¥½å‹ç”³è¯·</div>'; return; }
            container.innerHTML = myRequests.map(r => `<div class="friend-item"><div class="friend-info"><div class="friend-avatar">${r.fromName.charAt(0)}</div><div><div class="friend-name">${r.fromName}</div><div class="friend-status">å­¦å·: ${r.from} | ${r.time}</div></div></div><button class="btn btn-success btn-small" onclick="acceptFriendRequest(${r.id})">æ¥å—</button> <button class="btn btn-danger btn-small" onclick="rejectFriendRequest(${r.id})">æ‹’ç»</button></div>`).join('');
        }
        function acceptFriendRequest(requestId) {
            const request = friendRequests.find(r => r.id === requestId);
            if (!request) return;
            request.status = 'accepted';
            let myFriends = getMyFriends();
            myFriends.push({code: request.from, name: request.fromName, addTime: new Date().toLocaleString()});
            saveMyFriends(myFriends);
            let otherFriends = getFriendsByCode(request.from);
            otherFriends.push({code: currentStudent.code, name: currentStudent.name, addTime: new Date().toLocaleString()});
            saveFriendsByCode(request.from, otherFriends);
            saveData();
            updateFriendRequests();
            updateStudentFriendList();
            alert(`å·²æ·»åŠ  ${request.fromName} ä¸ºå¥½å‹ï¼`);
        }
        function rejectFriendRequest(requestId) {
            if (!confirm('ç¡®å®šæ‹’ç»è¯¥å¥½å‹ç”³è¯·ï¼Ÿ')) return;
            const request = friendRequests.find(r => r.id === requestId);
            if (request) request.status = 'rejected';
            saveData();
            updateFriendRequests();
        }
        function getMyFriends() {
            return JSON.parse(localStorage.getItem('myFriends_' + currentStudent.code) || '[]');
        }
        function saveMyFriends(friends) {
            localStorage.setItem('myFriends_' + currentStudent.code, JSON.stringify(friends));
        }
        function getFriendsByCode(code) {
            return JSON.parse(localStorage.getItem('myFriends_' + code) || '[]');
        }
        function saveFriendsByCode(code, friends) {
            localStorage.setItem('myFriends_' + code, JSON.stringify(friends));
        }
        function updateStudentFriendList() {
            const list = document.getElementById('student-friend-list');
            const countEl = document.getElementById('friend-count');
            if (!currentStudent) return;
            const myFriends = getMyFriends();
            if (countEl) countEl.textContent = myFriends.length;
            if (!list) return;
            if (myFriends.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¤</div>æš‚æ— å¥½å‹ï¼Œå¿«å»æ·»åŠ å§ï¼</div>'; return; }
            list.innerHTML = myFriends.map(f => {
                const chatKey = getChatKey(currentStudent.code, f.code);
                const lastMsg = getLastMessage(chatKey);
                const unreadCount = getUnreadMessageCount(chatKey);
                const unreadBadge = unreadCount > 0 ? `<span style="background:#EF4444;color:white;padding:2px 8px;border-radius:10px;font-size:11px;">${unreadCount}</span>` : '';
                return `<div class="friend-item" style="cursor:pointer;" onclick="openChat('${f.code}','${f.name}')"><div class="friend-info"><div class="friend-avatar">${f.name.charAt(0)}</div><div style="flex:1;"><div class="friend-name">${f.name}</div><div class="friend-status" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px;">${lastMsg || 'ç‚¹å‡»å¼€å§‹èŠå¤©'}</div></div></div><div style="display:flex;align-items:center;gap:10px;">${unreadBadge}<button class="btn btn-danger btn-small" onclick="event.stopPropagation();removeStudentFriend('${f.code}')">åˆ é™¤</button></div></div>`;
            }).join('');
        }
        function getUnreadMessageCount(chatKey) {
            const msgs = chatMessages[chatKey] || [];
            return msgs.filter(m => m.from !== currentStudent.code && !m.read).length;
        }
        function getChatKey(code1, code2) {
            return [code1, code2].sort().join('_');
        }
        function getLastMessage(chatKey) {
            const msgs = chatMessages[chatKey] || [];
            if (msgs.length === 0) return '';
            return msgs[msgs.length - 1].content.substring(0, 20) + (msgs[msgs.length - 1].content.length > 20 ? '...' : '');
        }
        function removeStudentFriend(code) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥å¥½å‹ï¼Ÿåˆ é™¤åèŠå¤©è®°å½•å°†æ¸…ç©ºï¼')) return;
            let myFriends = getMyFriends();
            myFriends = myFriends.filter(f => f.code !== code);
            saveMyFriends(myFriends);
            let otherFriends = getFriendsByCode(code);
            otherFriends = otherFriends.filter(f => f.code !== currentStudent.code);
            saveFriendsByCode(code, otherFriends);
            const chatKey = getChatKey(currentStudent.code, code);
            delete chatMessages[chatKey];
            saveData();
            updateStudentFriendList();
        }
        function openChat(friendCode, friendName) {
            document.getElementById('chat-modal-friend-code').value = friendCode;
            document.getElementById('chat-modal-friend-name').textContent = friendName;
            document.getElementById('chat-modal').classList.add('active');
            renderChatMessages(friendCode);
            // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('chat-input').focus();
            }, 100);
        }
        function renderChatMessages(friendCode) {
            const container = document.getElementById('chat-messages');
            if (!container || !currentStudent) return;
            const chatKey = getChatKey(currentStudent.code, friendCode);
            const msgs = chatMessages[chatKey] || [];
            if (msgs.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’¬</div>æš‚æ— èŠå¤©è®°å½•ï¼Œå‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å§ï¼</div>'; return; }
            
            // ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ï¼šä½¿ç”¨æ–‡æ¡£ç‰‡æ®µå‡å°‘DOMæ“ä½œ
            const fragment = document.createDocumentFragment();
            
            // æŒ‰æ—¶é—´æˆ³æ’åº
            const sortedMsgs = [...msgs].sort((a, b) => a.timestamp - b.timestamp);
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groupedMsgs = {};
            sortedMsgs.forEach(msg => {
                const date = new Date(msg.timestamp).toISOString().split('T')[0];
                if (!groupedMsgs[date]) groupedMsgs[date] = [];
                groupedMsgs[date].push(msg);
            });
            
            // ç”ŸæˆHTML
            let html = '';
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            for (const date in groupedMsgs) {
                let dateLabel = date;
                if (date === today) dateLabel = 'ä»Šå¤©';
                else if (date === yesterday) dateLabel = 'æ˜¨å¤©';
                else {
                    const dateObj = new Date(date);
                    dateLabel = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                }
                html += `<div style="text-align:center;margin:15px 0;"><span style="display:inline-block;padding:4px 12px;background:#e2e8f0;border-radius:12px;font-size:12px;color:#64748b;">${dateLabel}</span></div>`;
                
                groupedMsgs[date].forEach(m => {
                    const isMe = m.from === currentStudent.code;
                    let statusIcon = '';
                    if (isMe) {
                        if (m.status === 'sending') statusIcon = 'â³';
                        else if (m.read) statusIcon = 'âœ“âœ“';
                        else if (m.status === 'sent') statusIcon = 'âœ“';
                        else if (m.status === 'deleted') statusIcon = 'ğŸ—‘ï¸';
                    }
                    html += `<div style="display:flex;justify-content:${isMe ? 'flex-end' : 'flex-start'};margin-bottom:12px;position:relative;"><div class="message-bubble ${isMe ? 'me' : 'other'}" oncontextmenu="showMessageMenu(event, ${m.id}, '${friendCode}')"><div class="message-content">${m.content}</div><div class="message-info ${isMe ? 'me' : ''}"><span>${m.time}</span><span class="message-status">${statusIcon}</span></div></div></div>`;
                });
            }
            
            // åˆ›å»ºä¸´æ—¶å…ƒç´ å¹¶è®¾ç½®innerHTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // å°†ä¸´æ—¶å…ƒç´ çš„æ‰€æœ‰å­èŠ‚ç‚¹æ·»åŠ åˆ°æ–‡æ¡£ç‰‡æ®µ
            while (tempDiv.firstChild) {
                fragment.appendChild(tempDiv.firstChild);
            }
            
            // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–‡æ¡£ç‰‡æ®µï¼ˆå•æ¬¡DOMæ“ä½œï¼‰
            container.innerHTML = '';
            container.appendChild(fragment);
            
            container.scrollTop = container.scrollHeight;
            markMessagesAsRead(friendCode);
        }
        function markMessagesAsRead(friendCode) {
            const chatKey = getChatKey(currentStudent.code, friendCode);
            if (chatMessages[chatKey]) {
                chatMessages[chatKey].forEach(msg => {
                    if (msg.from !== currentStudent.code && !msg.read) {
                        msg.read = true;
                    }
                });
                saveData();
            }
        }
        function showMessageMenu(event, messageId, friendCode) {
            event.preventDefault();
            const chatKey = getChatKey(currentStudent.code, friendCode);
            const message = chatMessages[chatKey]?.find(m => m.id === messageId);
            if (!message) return;
            const isMe = message.from === currentStudent.code;
            
            const options = ['å¤åˆ¶æ¶ˆæ¯'];
            if (isMe) options.push('æ’¤å›æ¶ˆæ¯');
            
            const choice = prompt('è¯·é€‰æ‹©æ“ä½œ:\n1. å¤åˆ¶æ¶ˆæ¯\n' + (isMe ? '2. æ’¤å›æ¶ˆæ¯' : ''), '1');
            
            if (choice === '1') {
                copyMessage(message.content);
            } else if (choice === '2' && isMe) {
                if (confirm('ç¡®å®šè¦æ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                    deleteMessage(messageId, friendCode);
                }
            }
        }
        
        function copyMessage(content) {
            navigator.clipboard.writeText(content).then(() => {
                alert('æ¶ˆæ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + content);
            });
        }
        
        function clearChatHistory() {
            const friendCode = document.getElementById('chat-modal-friend-code').value;
            if (!friendCode) return;
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºä¸ ' + document.getElementById('chat-modal-friend-name').textContent + ' çš„èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            const chatKey = getChatKey(currentStudent.code, friendCode);
            delete chatMessages[chatKey];
            saveData();
            renderChatMessages(friendCode);
            alert('èŠå¤©è®°å½•å·²æ¸…ç©ºï¼');
        }
        
        function searchChat() {
            const friendCode = document.getElementById('chat-modal-friend-code').value;
            const keyword = document.getElementById('chat-search').value.trim();
            if (!keyword) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼');
                return;
            }
            const chatKey = getChatKey(currentStudent.code, friendCode);
            const msgs = chatMessages[chatKey] || [];
            const searchResults = msgs.filter(m => 
                m.content.toLowerCase().includes(keyword.toLowerCase())
            );
            document.getElementById('clear-search-btn').style.display = 'block';
            renderChatMessagesWithResults(friendCode, searchResults, keyword);
        }
        
        function clearSearch() {
            document.getElementById('chat-search').value = '';
            document.getElementById('clear-search-btn').style.display = 'none';
            const friendCode = document.getElementById('chat-modal-friend-code').value;
            renderChatMessages(friendCode);
        }
        
        function renderChatMessagesWithResults(friendCode, searchResults, keyword) {
            const container = document.getElementById('chat-messages');
            if (!container || !currentStudent) return;
            if (searchResults.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ”</div>æœªæ‰¾åˆ°åŒ…å« "${keyword}" çš„èŠå¤©è®°å½•</div>`;
                return;
            }
            container.innerHTML = `<div style="text-align:center;margin-bottom:15px;padding:10px;background:#f1f5f9;border-radius:8px;"><span style="font-size:14px;color:#64748b;">æœç´¢ç»“æœï¼šæ‰¾åˆ° ${searchResults.length} æ¡åŒ…å« "${keyword}" çš„æ¶ˆæ¯</span></div>` + 
                searchResults.map(m => {
                    const isMe = m.from === currentStudent.code;
                    let statusIcon = '';
                    if (isMe) {
                        if (m.status === 'sending') statusIcon = 'â³';
                        else if (m.read) statusIcon = 'âœ“âœ“';
                        else if (m.status === 'sent') statusIcon = 'âœ“';
                        else if (m.status === 'deleted') statusIcon = 'ğŸ—‘ï¸';
                    }
                    return `<div style="display:flex;justify-content:${isMe ? 'flex-end' : 'flex-start'};margin-bottom:12px;position:relative;"><div class="message-bubble ${isMe ? 'me' : 'other'}" oncontextmenu="showMessageMenu(event, ${m.id}, '${friendCode}')"><div class="message-content">${m.content}</div><div class="message-info ${isMe ? 'me' : ''}"><span>${m.time}</span><span class="message-status">${statusIcon}</span></div></div></div>`;
                }).join('');
            container.scrollTop = 0;
        }
        function deleteMessage(messageId, friendCode) {
            const chatKey = getChatKey(currentStudent.code, friendCode);
            if (chatMessages[chatKey]) {
                const index = chatMessages[chatKey].findIndex(m => m.id === messageId);
                if (index !== -1) {
                    chatMessages[chatKey][index].content = '[æ¶ˆæ¯å·²æ’¤å›]';
                    chatMessages[chatKey][index].status = 'deleted';
                    saveData();
                    renderChatMessages(friendCode);
                }
            }
        }
        function sendChatMessage() {
            const friendCode = document.getElementById('chat-modal-friend-code').value;
            const content = document.getElementById('chat-input').value.trim();
            if (!content) return;
            const chatKey = getChatKey(currentStudent.code, friendCode);
            if (!chatMessages[chatKey]) chatMessages[chatKey] = [];
            const message = {
                id: Date.now(),
                from: currentStudent.code,
                fromName: currentStudent.name,
                content,
                time: new Date().toLocaleTimeString('zh-CN', {hour12: false}),
                timestamp: Date.now(),
                status: 'sending',
                read: false
            };
            chatMessages[chatKey].push(message);
            saveData();
            document.getElementById('chat-input').value = '';
            renderChatMessages(friendCode);
            
            // æ¨¡æ‹Ÿå‘é€å»¶è¿Ÿï¼Œæ›´æ–°ä¸ºå·²å‘é€çŠ¶æ€
            setTimeout(() => {
                const msgIndex = chatMessages[chatKey].findIndex(m => m.id === message.id);
                if (msgIndex !== -1) {
                    chatMessages[chatKey][msgIndex].status = 'sent';
                    saveData();
                    renderChatMessages(friendCode);
                }
            }, 500);
        }
        function updateStudentCallHistory() {
            const container = document.getElementById('student-call-history');
            const alert = document.getElementById('student-call-alert');
            const alertContent = document.getElementById('student-call-content');
            if (!currentStudent) return;
            const myCalls = callRecords.filter(c => c.code === currentStudent.code);
            const waitingCalls = myCalls.filter(c => c.status === 'waiting');
            if (waitingCalls.length > 0) {
                document.getElementById('call-badge').classList.add('active');
                if (alert) { alert.classList.add('active'); if (alertContent) alertContent.innerHTML = `ä»»åŠ¡ï¼š${waitingCalls[0].task || 'æ¥åŠå…¬å®¤ä¸€è¶Ÿ'}<br>å‘¼å«æ—¶é—´ï¼š${waitingCalls[0].callTime}`; }
                speakText(`è¯·${currentStudent.name}åŒå­¦ï¼Œ${waitingCalls[0].task || 'æ¥åŠå…¬å®¤ä¸€è¶Ÿ'}`);
            } else { if (alert) alert.classList.remove('active'); }
            if (!container) return;
            if (myCalls.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¢</div>æš‚æ— å«å·è®°å½•</div>'; return; }
            container.innerHTML = myCalls.map(c => {
                let statusTag = c.status === 'arrived' ? '<span class="tag tag-success">å·²åˆ°è¾¾</span>' : (c.status === 'waiting' ? '<span class="tag tag-warning">ç­‰å¾…ä¸­</span>' : '<span class="tag tag-danger">å·²å–æ¶ˆ</span>');
                return `<div class="message-item"><div class="message-header"><span class="message-from">ä»»åŠ¡ï¼š${c.task || 'æ¥åŠå…¬å®¤ä¸€è¶Ÿ'}</span><span class="message-time">${c.callTime}</span></div><div class="message-content">çŠ¶æ€ï¼š${statusTag}</div></div>`;
            }).join('');
        }
        function startCallCheck() {
            callCheckInterval = setInterval(() => {
                loadData();
                const myCalls = callRecords.filter(c => c.code === currentStudent.code && c.status === 'waiting');
                if (myCalls.length > 0) {
                    document.getElementById('call-badge').classList.add('active');
                    updateStudentCallHistory();
                }
            }, 5000);
        }
        
        checkSession();
    </script>
</body>
</html>
